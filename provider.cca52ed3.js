var Zi={withStackTrace:!1},zr=(r,e,t=Zi)=>{let n=e.isOk()?{type:"Ok",value:e.value}:{type:"Err",value:e.error},i=t.withStackTrace?new Error().stack:void 0;return{data:n,message:r,stack:i}};function lr(r,e,t,n){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(c){try{l(n.next(c))}catch(m){o(m)}}function u(c){try{l(n.throw(c))}catch(m){o(m)}}function l(c){c.done?s(c.value):i(c.value).then(a,u)}l((n=n.apply(r,e||[])).next())})}function Kr(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Fe(r){return this instanceof Fe?(this.v=r,this):new Fe(r)}function es(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(r,e||[]),i,s=[];return i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i;function o(p){n[p]&&(i[p]=function(h){return new Promise(function(g,O){s.push([p,h,g,O])>1||a(p,h)})})}function a(p,h){try{u(n[p](h))}catch(g){m(s[0][3],g)}}function u(p){p.value instanceof Fe?Promise.resolve(p.value.v).then(l,c):m(s[0][2],p)}function l(p){a("next",p)}function c(p){a("throw",p)}function m(p,h){p(h),s.shift(),s.length&&a(s[0][0],s[0][1])}}function ts(r){var e,t;return e={},n("next"),n("throw",function(i){throw i}),n("return"),e[Symbol.iterator]=function(){return this},e;function n(i,s){e[i]=r[i]?function(o){return(t=!t)?{value:Fe(r[i](o)),done:i==="return"}:s?s(o):o}:s}}function rs(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof Kr=="function"?Kr(r):r[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(s){t[s]=r[s]&&function(o){return new Promise(function(a,u){o=r[s](o),i(a,u,o.done,o.value)})}}function i(s,o,a,u){Promise.resolve(u).then(function(l){s({value:l,done:a})},o)}}var ve=class r{constructor(e){this._promise=e}static fromSafePromise(e){let t=e.then(n=>new ge(n));return new r(t)}static fromPromise(e,t){let n=e.then(i=>new ge(i)).catch(i=>new ue(t(i)));return new r(n)}static combine(e){return is(e)}static combineWithAllErrors(e){return ss(e)}map(e){return new r(this._promise.then(t=>lr(this,void 0,void 0,function*(){return t.isErr()?new ue(t.error):new ge(yield e(t.value))})))}mapErr(e){return new r(this._promise.then(t=>lr(this,void 0,void 0,function*(){return t.isOk()?new ge(t.value):new ue(yield e(t.error))})))}andThen(e){return new r(this._promise.then(t=>{if(t.isErr())return new ue(t.error);let n=e(t.value);return n instanceof r?n._promise:n}))}orElse(e){return new r(this._promise.then(t=>lr(this,void 0,void 0,function*(){return t.isErr()?e(t.error):new ge(t.value)})))}match(e,t){return this._promise.then(n=>n.match(e,t))}unwrapOr(e){return this._promise.then(t=>t.unwrapOr(e))}safeUnwrap(){return es(this,arguments,function*(){return yield Fe(yield Fe(yield*ts(rs(yield Fe(this._promise.then(t=>t.safeUnwrap()))))))})}then(e,t){return this._promise.then(e,t)}},We=r=>new ve(Promise.resolve(new ge(r))),qe=r=>new ve(Promise.resolve(new ue(r))),Ie=ve.fromPromise,ia=ve.fromSafePromise,ns=r=>e=>[...e,r],Jr=r=>r.reduce((e,t)=>e.isOk()?t.isErr()?v(t.error):e.map(ns(t.value)):e,f([])),is=r=>ve.fromSafePromise(Promise.all(r)).andThen(Jr),Zr=r=>r.reduce((e,t)=>t.isErr()?e.isErr()?v([...e.error,t.error]):v([t.error]):e.isErr()?e:f([...e.value,t.value]),f([])),ss=r=>ve.fromSafePromise(Promise.all(r)).andThen(Zr),cr;(function(r){function e(i,s){return(...o)=>{try{let a=i(...o);return f(a)}catch(a){return v(s?s(a):a)}}}r.fromThrowable=e;function t(i){return Jr(i)}r.combine=t;function n(i){return Zr(i)}r.combineWithAllErrors=n})(cr||(cr={}));var f=r=>new ge(r),v=r=>new ue(r);var ge=class{constructor(e){this.value=e}isOk(){return!0}isErr(){return!this.isOk()}map(e){return f(e(this.value))}mapErr(e){return f(this.value)}andThen(e){return e(this.value)}orElse(e){return f(this.value)}asyncAndThen(e){return e(this.value)}asyncMap(e){return ve.fromSafePromise(e(this.value))}unwrapOr(e){return this.value}match(e,t){return e(this.value)}safeUnwrap(){let e=this.value;return function*(){return e}()}_unsafeUnwrap(e){return this.value}_unsafeUnwrapErr(e){throw zr("Called `_unsafeUnwrapErr` on an Ok",this,e)}},ue=class{constructor(e){this.error=e}isOk(){return!1}isErr(){return!this.isOk()}map(e){return v(this.error)}mapErr(e){return v(e(this.error))}andThen(e){return v(this.error)}orElse(e){return e(this.error)}asyncAndThen(e){return qe(this.error)}asyncMap(e){return qe(this.error)}unwrapOr(e){return e}match(e,t){return t(this.error)}safeUnwrap(){let e=this.error;return function*(){throw yield v(e),new Error("Do not use this generator out of `safeTry`")}()}_unsafeUnwrap(e){throw zr("Called `_unsafeUnwrap` on an Err",this,e)}_unsafeUnwrapErr(e){return this.error}},sa=cr.fromThrowable;function en(r){return[...new Set(r)]}var nt=Object.keys,Xe=Object.entries;function ye(r,e){return Object.prototype.hasOwnProperty.call(r,e)}function G(r,e){return e in r}function P(r,e,t){Object.defineProperty(r,e,t)}function tn(r,e){return Object.getOwnPropertyDescriptor(r,e)}function rn(r){return Object.getOwnPropertyNames(r)}function dr(r,e){return Object.assign(r,e)}function os(r){if(r===void 0){if(typeof navigator=="undefined")return!1;r=navigator.userAgent}return r.includes("Firefox")}var ht=os();function as(r,e){if(r===void 0){if(typeof navigator=="undefined")return!1;r=navigator.userAgent}if(e===void 0){if(typeof window=="undefined")return!1;e=window}return/iPad|iPhone|iPod/.test(r)&&!ye(e,"MSStream")}function nn(){return typeof navigator!="undefined"&&navigator.userAgent!==void 0&&navigator.userAgent.match(/like Mac OS X/)!==null&&navigator.userAgent.match(/OS 14/)!==null}var ca=as();function x(r,e,t){return Math.min(Math.max(r,e),t)}function fr(r){return!us(r)}function us(r){return r===void 0}function ls(r){return r===null}function Te(r){return typeof r=="object"&&!ls(r)}function Ye(r){return Array.isArray(r)}function Ue(r){return typeof r=="number"&&!isNaN(r)}function hr(r){return typeof r=="string"}function pr(r){return Ye(r)?r.map(e=>pr(e)):r instanceof Date?new Date(r.getTime()):Te(r)?rn(r).reduce((e,t)=>{let n=tn(r,t);return P(e,t,n),e[t]=pr(r[t]),e},Object.create(Object.getPrototypeOf(r))):r}function sn(r){return pr(r)}var $="master",oe="OUTPUT";var on=34028234663852886e22,an=-34028234663852886e22,un=40,ln=-40,cn=0,dn=1,fn=0,hn=40,pn=1,mn=20,bn=1,gn=0,vn=-100,yn=0;function j(r){return r instanceof Error?r:new Error(JSON.stringify(r))}function wn(r){return v(j(r))}function I(r){return v(new Error(r))}function mr(r){return qe(new Error(r))}var br=class{constructor(){Object.defineProperty(this,"map",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}addEventListener(e,t,n){var i;let s=this.map,o=s.get(e),a=(i=n==null?void 0:n.once)!==null&&i!==void 0?i:!1;o===void 0?s.set(e,[[t,a]]):o.push([t,a])}removeEventListener(e,t){let n=this.map.get(e);if(n!==void 0){for(let i=0;i<n.length;i++)if(n[i][0]===t){n.splice(i,1);return}}}dispatchEvent(e){let t=e.type,n=this.map.get(t);if(n===void 0)return!0;for(let i=0;i<n.length;i++){let[s,o]=n[i];s(e),o&&(this.removeEventListener(t,s),i--)}return!0}dispose(){this.map.clear()}},De=class extends br{dispatch(e,t){return this.map.get(e)===void 0?!0:this.dispatchEvent({type:e,detail:t})}removeEventListeners(){this.map.clear()}};function Qe(){if(Promise.withResolvers!==void 0)return Promise.withResolvers();let r,e,t=(i,s)=>{r=i,e=s};return{promise:new Promise(t),resolve:r,reject:e}}function cs(r){return{get:e=>{let t=r.get(e);return t===void 0?v(new Error(`[ecas] ${String(e)} not found`)):f(t)}}}function pt(r){let{hash:e="",search:t=""}=r!=null?r:typeof window=="undefined"?{hash:"",search:""}:window.location,n=On(e),i=On(t),s=[...n,...i],o=Array.from(new Set(s)),a=cs(new Map(o));return{get:u=>a.get(u.toLowerCase().replace(/-/g,""))}}function On(r){return r.toLowerCase().replace(/\?/g,"").replace(/#/g,"").replace(/-/g,"").split("&").map(e=>{var t;let n=e.split("=");return[n[0],(t=n[1])!==null&&t!==void 0?t:"none"]}).filter(e=>e!==void 0)}function H(){}var mt=class{constructor(...e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.items=[...e].sort((t,n)=>n.priority-t.priority)}enqueue(e){let t=this.findIndex(n=>n.priority<e.priority);t===void 0?this.items.push(e):this.items.splice(t,0,e)}dequeue(){return this.dequeueIndex(0)}dequeueLast(){return this.dequeueIndex(this.items.length-1)}dequeueIndex(e){return this.items.splice(e,1)[0]}dequeueOneByPredicate(e){let t=this.findIndex(e);return t===void 0?void 0:this.dequeueIndex(t)}dequeueByPredicate(e){let t=this.findIndexes(e),n=0;return t.map(i=>this.dequeueIndex(i-n++))}last(){return this.items[this.items.length-1]}first(){return this.items[0]}clear(){this.items.splice(0,this.items.length)}findIndex(e){let t=this.items.findIndex(e);return t>-1?t:void 0}findIndexes(e){let t=[];for(let[n,i]of this.items.entries())e(i)&&t.push(n);return t}removeIndex(e){this.items.splice(e,1)}removeByPredicate(e){let t=this.findIndex(e);t!==void 0&&this.removeIndex(t)}get length(){return this.items.length}get highestPriority(){var e,t;return(t=(e=this.items[0])===null||e===void 0?void 0:e.priority)!==null&&t!==void 0?t:-Number.MAX_SAFE_INTEGER}get lowestPriority(){var e,t;return(t=(e=this.items[this.items.length-1])===null||e===void 0?void 0:e.priority)!==null&&t!==void 0?t:-Number.MAX_SAFE_INTEGER}*drain(){let e=this.items.shift();for(;e!==void 0;)yield e,e=this.items.shift()}*next(){for(let e of this.items)yield e}};var it=class{constructor(...e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.items=[...e]}enqueue(...e){this.items.push(...e)}dequeue(){return this.items.shift()}dequeueLast(){return this.items.pop()}dequeueIndex(e){return this.items.splice(e,1)[0]}dequeueOneByPredicate(e){let t=this.findIndex(e);return t===void 0?void 0:this.dequeueIndex(t)}dequeueByPredicate(e){let t=this.findIndexes(e),n=0;return t.map(i=>this.dequeueIndex(i-n++))}last(){return this.items[this.items.length-1]}first(){return this.items[0]}clear(){this.items.splice(0,this.items.length)}findIndex(e){let t=this.items.findIndex(e);return t>-1?t:void 0}findIndexes(e){let t=[];for(let[n,i]of this.items.entries())e(i)&&t.push(n);return t}removeIndex(e){this.items.splice(e,1)}removeByPredicate(e){let t=this.findIndex(e);t!==void 0&&this.removeIndex(t)}get length(){return this.items.length}*drain(){let e=this.items.shift();for(;e!==void 0;)yield e,e=this.items.shift()}*next(){for(let e of this.items)yield e}};function xn(r){return(...e)=>{try{return[null,r(...e)]}catch(t){return[t,null]}}}function bt(r=pt()){let e=r.get("ecasws").unwrapOr("none");return decodeURIComponent(e.replace(/%22/g,""))}var Ne={typename:"none",debug:H,log:H,info:H,warn:H,error:H,table:H,trace:H},d=ds;function ds(){return Ne}function Pn(r){Ne=r}function gt(r){Ne=fs(r)}function En(r,e){Ne=In(r,e)}function fs(r){switch(r){case"console":return ms();case"websocket":return In();case"none":default:return bs()}}function Sn(r=window.location){var e,t;gt((t=(e=An(r.hash))!==null&&e!==void 0?e:_n(r.search))!==null&&t!==void 0?t:"none")}function An(r){let t=r.substring(1).split("&");for(let n of t){let[i,s]=n.split("=");if((i==="ecas-logger"||i==="ecasLogger")&&vt(s))return s}return null}function _n(r){var e;let t=new URLSearchParams(r),n=(e=t.get("ecas-logger"))!==null&&e!==void 0?e:t.get("ecasLogger");return vt(n)?n:null}function vt(r){return r==="none"||r==="console"||r==="timestamp"||r==="websocket"}function hs(r){return vt(_n(r))}function ps(r){return vt(An(r))}function jn(r=window.location){return ps(r.hash)||hs(r.search)}function ms(){let r=[];return Object.assign(Object.assign({typename:"console"},console),{errors:r,onerror:e=>{r.push(e),console.debug(e.message)}})}function In(r=bt(),e){if(e!==void 0)try{e=new WebSocket(r)}catch(n){}let t=(n,i)=>{let s=performance.now();(e==null?void 0:e.readyState)===WebSocket.OPEN&&(e==null||e.send(JSON.stringify({type:"log",data:{message:JSON.stringify(n),level:i,timestamp:s}})))};return{typename:"websocket",debug:(...n)=>{t(n,"debug")},log:(...n)=>{t(n,"log")},info:(...n)=>{t(n,"info")},warn:(...n)=>{t(n,"warn")},error:(...n)=>{t(n,"error")},table:(...n)=>{t(n,"table")},trace:(...n)=>{t(n,"trace")},socket:e}}function bs(){return{typename:"none",debug:H,log:H,info:H,warn:H,error:H,table:H,trace:H}}var yt=(r,...e)=>{var t;let n="";for(let i=0;i<r.raw.length;i++)n+=r.raw[i]+String((t=e[i])!==null&&t!==void 0?t:"");return n},M=(...r)=>{Ne.debug(yt(...r))},Tn=(...r)=>{Ne.log(yt(...r))};var de=(...r)=>{Ne.warn(yt(...r))},gr=(...r)=>{Ne.error(yt(...r))};var vr=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"AutomatorError"})}},C=class{constructor(e){Object.defineProperty(this,"AutomatableParameters",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"audioParams",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"defaults",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}automate({paramId:e,valueCurve:t,when:n,duration:i}){let{debug:s}=d();s("[ecas] automate",{paramId:e,when:n,duration:i,length:t.length,firstValue:t[0],lastValue:t[t.length-1]});let o=this.audioParams.get(e);if(o===void 0)return v(new Error(`AudioParam with id ${String(e)} has not been added.`));try{o.cancelAndHoldAtTime(0)}catch(u){s("[ecas] automate: failed to cancel and hold at time",j(u).message)}if(t.length===0)return I("valueCurve is empty");if(t.length===1)try{return s("[ecas] automate: valueCurve has only one value, setting value directly"),o.linearRampToValueAtTime(t[0],n+i),f(void 0)}catch(u){return v(new Error("failed to schedule linearRampToValueAtTime."))}if(ht)return this.firefoxHack({paramId:e,valueCurve:t,when:n,duration:i,audioParam:o});try{return o.setValueCurveAtTime(Float32Array.from(t),n,i),f(void 0)}catch(u){s("[ecas]: failed to schedule value curve, using a linear ramp to the end value instead: ",j(u).message)}let a=t[t.length-1];try{o.cancelAndHoldAtTime(0)}catch(u){}try{return o.linearRampToValueAtTime(a,n+i),f(void 0)}catch(u){return s("[ecas]: failed to schedule linear ramp to value at time that was used as a fallback when the valueCurve failed: ",j(u).message),v(new Error("failed to schedule linearRampToValueAtTime."))}}firefoxHack({audioParam:e,valueCurve:t,when:n,duration:i}){let s=t.length,o=i/s;e.cancelAndHoldAtTime(0);let a=null;for(let[u,l]of t.entries()){let c=u*o;try{e.linearRampToValueAtTime(l,n+c)}catch(m){a=j(m)}}return a===null?f(void 0):v(a)}add(e,t,n){return this.audioParams.has(e)?v(new vr(`AudioParam with id ${String(e)} has already been added.`)):(this.set(e,t),this.setDefault(e,n!=null?n:t.value),f(void 0))}cancel({paramId:e,when:t}){var n;try{return(n=this.audioParams.get(e))===null||n===void 0||n.cancelScheduledValues(t),f(void 0)}catch(i){return v(j(i))}}get(e){return this.audioParams.get(e)}set(e,t){this.audioParams.set(e,t)}current(e){var t;return(t=this.audioParams.get(e))===null||t===void 0?void 0:t.value}getDefault(e){return this.defaults.get(e)}setDefault(e,t){this.defaults.set(e,t)}dispose(){for(let e of this.audioParams.values())e.cancelScheduledValues(0);this.audioParams.clear(),this.defaults.clear()}};function Dn(r=1,e=10,t=10){let n=l=>l>0?Math.log10(l):Math.log10(1e-5),i=n(r),o=(n(e)-i)/(t-1),a=new Float32Array(t),u=i;a[0]=r;for(let l=1;l<t-1;l++)u+=o,a[l]=Math.pow(10,u);return a[t-1]=e,a}function gs(r=1,e=10,t=10){let n=(e-r)/(t-1),i=new Float32Array(t),s=r;for(let o=0;o<t;o++)i[o]=s,s+=n;return i[0]=r,i[i.length-1]=e,i}function vs(r=1,e=0,t=10){let n=Math.PI/2,i=new Float32Array(t);for(let o=0;o<t;o++){let u=Math.PI*o/(t-1)-n;i[o]=Math.sin(u)/2+.5}let s=e-r;for(let o=0;o<t;o++){let a=i[o];a!==void 0&&(i[o]=a*s+r)}return i}function Nn(r=0,e=1,t=10,n=Math.sin){if(r===e)return new Float32Array(t).fill(r);let i=new Float32Array(t);for(let o=0;o<t;o++){let a=o/(t-1);i[o]=n(Math.PI/2*a)}let s=e-r;for(let o=0;o<t;o++)i[o]=i[o]*s+r;return i}function ys(r=1,e=0,t=10){return Nn(r,e,t,Math.sin)}function ws(r=1,e=0,t=10){return Nn(e,r,t,Math.cos)}function Cn(r,e,t){let n=e.reduce((a,u)=>a+u,0),i=new Float32Array(n),s=r[0],o=0;for(let a=0;a<r.length;a++){let u=e[a],l=r[a];i.set(t(s,l,u),o),o+=u,s=l}return i}var Os={linear:gs,exponential:Dn,logarithmic:Dn,"s-curve":vs,sine:ys,cosine:ws};function Rn(r){return Os[r]}var Ln={linear(r){return Ke("linear",r)},logarithmic(r){return Ke("logarithmic",r)},exponential(r){return Ke("exponential",r)},"s-curve"(r){return Ke("s-curve",r)},sine(r){return Ke("sine",r)},cosine(r){return Ke("cosine",r)}};var xs=.008;function Ke(r,[e,t]){let n=t.map(i=>Math.floor(Math.max(i*xs,2)));return[Cn(e,n,Rn(r)),t.reduce((i,s)=>i+s,0)/1e3]}function we({automator:r,context:e,paramId:t,curve:n,points:i,initialDelay:s=0,when:o=e.currentTime}){let a=Ps(i),u=({val:h})=>{var g,O;return h==="default"?(g=r.getDefault(t))!==null&&g!==void 0?g:.001:h==="current"?(O=r.current(t))!==null&&O!==void 0?O:.001:h},l=a.map(u),c=a.map(({pos:h})=>h),[m,p]=Ln[n!=null?n:"linear"]([l,c]);return r.automate({paramId:t,valueCurve:m,when:o+s,duration:p})}function Ps(r){var e;let t=[...r];return((e=r[0])===null||e===void 0?void 0:e.pos)!==0&&t.unshift({pos:0,val:"current"}),t}function K(r,e){var t={};for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(r);i<n.length;i++)e.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(r,n[i])&&(t[n[i]]=r[n[i]]);return t}function Ce(r,e){let t=Object.assign(Object.assign({},r),e);return e.dryGain!==void 0&&e.wetGain!==void 0?Object.assign(Object.assign(Object.assign({},r),e),{mix:x(e.wetGain,1e-4,1)}):e.mix!==void 0?Object.assign(Object.assign(Object.assign({},r),e),{dryGain:x(1-e.mix,1e-4,1),wetGain:x(e.mix,1e-4,1)}):t}var wt="AlgorithmicReverbInsert",Es=["dry-gain","wet-gain"],z=class r{get id(){return this.options.id}get input(){return this.nodes.input}get output(){return this.nodes.output}constructor(e,t={id:wt}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:wt}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Es)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Ce(r.defaultOptions,t),this.nodes={input:e.createGain(),output:e.createGain(),dry:e.createGain(),wet:e.createGain(),reverb:e.createConvolver()},this.input.connect(this.nodes.dry),this.input.connect(this.nodes.reverb),this.nodes.reverb.connect(this.nodes.wet),this.nodes.dry.connect(this.output),this.nodes.wet.connect(this.output),this.nodes.dry.gain.value=this.options.dryGain,this.nodes.wet.gain.value=this.options.wetGain,this.buildImpulse(),this.automator.add("dry-gain",this.nodes.dry.gain,this.options.dryGain),this.automator.add("wet-gain",this.nodes.wet.gain,this.options.wetGain)}buildImpulse(){let{time:e,decay:t,reverse:n}=this.options,i=this.context.sampleRate*e,s=this.context.createBuffer(2,i,this.context.sampleRate),o=s.getChannelData(0),a=s.getChannelData(1),u,l;for(l=0;l<i;l++)u=n?i-l:l,o[l]=(Math.random()*2-1)*Math.pow(1-u/i,t),a[l]=(Math.random()*2-1)*Math.pow(1-u/i,t);this.nodes.reverb.buffer=s}};Object.defineProperty(z,"typename",{enumerable:!0,configurable:!0,writable:!0,value:wt});Object.defineProperty(z,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:wt,mix:1,dryGain:1e-4,wetGain:1,time:.2,decay:.2,reverse:!1}});var _s=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"],Ot="BiquadFilterInsert",js=["frequency","detune","Q","gain"],J=class r{get id(){return this.options.id}get input(){return this.node}get output(){return this.node}constructor(e,t={id:Ot}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Ot}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(js)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Object.assign(Object.assign({},r.defaultOptions),t),this.node=e.createBiquadFilter(),this.updateFilterNode(),this.automator.add("Q",this.node.Q),this.automator.add("detune",this.node.detune),this.automator.add("frequency",this.node.frequency),this.automator.add("gain",this.node.gain)}updateFilterNode(){this.node.Q.value=x(this.options.Q,1e-4,1e3),this.node.detune.value=x(this.options.detune,an,on),this.node.frequency.value=x(this.options.frequency,10,this.context.sampleRate/2),this.node.gain.value=x(this.options.gain,ln,un),this.node.type=_s.includes(this.options.type)?this.options.type:r.defaultOptions.type}};Object.defineProperty(J,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Ot});Object.defineProperty(J,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:Ot,type:"lowpass",frequency:350,detune:0,Q:1,gain:0}});var xt="ReverbConvolverInsert",Is=["dry-gain","wet-gain"],Z=class r{get id(){return this.options.id}get input(){return this.nodes.input}get output(){return this.nodes.output}constructor(e,t={id:xt},n){Object.defineProperty(this,"bufferRequester",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:xt}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Is)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Ce(r.defaultOptions,t),this.nodes={input:e.createGain(),output:e.createGain(),dry:e.createGain(),wet:e.createGain(),reverb:e.createConvolver()},this.input.connect(this.nodes.dry),this.input.connect(this.nodes.reverb),this.nodes.reverb.connect(this.nodes.wet),this.nodes.dry.connect(this.output),this.nodes.wet.connect(this.output),t.impulseResponse===void 0&&d().warn(`[ecas] no impulseResponse specified for insert: ${this.id}`),this.nodes.dry.gain.value=this.options.dryGain,this.nodes.wet.gain.value=this.options.wetGain,this.nodes.reverb.normalize=this.options.normalize,this.updateBuffer().catch(d().error),this.automator.add("dry-gain",this.nodes.dry.gain,this.options.dryGain),this.automator.add("wet-gain",this.nodes.wet.gain,this.options.wetGain)}async updateBuffer(){var e;let t=(e=this.options.reverse)!==null&&e!==void 0?e:r.defaultOptions.reverse;try{this.nodes.reverb.buffer=t?await this.bufferRequester.requestBufferReversedAsync(this.options.impulseResponse):await this.bufferRequester.requestBufferAsync(this.options.impulseResponse)}catch(n){d().debug("[ecas] failed to load impulse response, setting buffer to null. Make sure to preload the impulse response audio file"),d().error(n),this.nodes.reverb.buffer=null}this.nodes.reverb.buffer===null&&d().warn(`[ecas] no impulse response buffer found for insert: ${this.id}`)}};Object.defineProperty(Z,"typename",{enumerable:!0,configurable:!0,writable:!0,value:xt});Object.defineProperty(Z,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:xt,normalize:!1,reverse:!1,impulseResponse:"none",mix:1,dryGain:1e-4,wetGain:1}});var Pt="DelayInsert",Ts=["delayTime","feedback","dry-gain","wet-gain","cutoff"],ee=class r{get id(){return this.options.id}get input(){return this.nodes.input}get output(){return this.nodes.output}constructor(e,t={id:Pt}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Pt}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Ts)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Ce(r.defaultOptions,t),this.nodes={input:e.createGain(),output:e.createGain(),dry:e.createGain(),wet:e.createGain(),feedback:e.createGain(),delay:e.createDelay(),filter:e.createBiquadFilter()},this.updateDelayOptions(t),this.nodes.dry.gain.value=this.options.dryGain,this.nodes.wet.gain.value=this.options.wetGain,this.input.connect(this.nodes.dry),this.nodes.dry.connect(this.output),this.nodes.delay.connect(this.nodes.feedback),this.nodes.feedback.connect(this.nodes.filter),this.nodes.filter.connect(this.nodes.delay),this.input.connect(this.nodes.delay),this.nodes.delay.connect(this.nodes.wet),this.nodes.wet.connect(this.output),this.automator.add("cutoff",this.nodes.filter.frequency),this.automator.add("delayTime",this.nodes.delay.delayTime),this.automator.add("feedback",this.nodes.feedback.gain),this.automator.add("dry-gain",this.nodes.dry.gain),this.automator.add("wet-gain",this.nodes.wet.gain)}updateDelayOptions({feedback:e,delayTime:t,maxDelayTime:n,cutoff:i}){this.options.maxDelayTime=n!==void 0?x(n,0,10):r.defaultOptions.maxDelayTime,this.options.delayTime=t!==void 0?x(t,0,this.options.maxDelayTime):r.defaultOptions.delayTime,this.options.feedback=e!==void 0?x(e,1e-4,1):r.defaultOptions.feedback,this.options.cutoff=i!==void 0?x(i,10,2e4):r.defaultOptions.cutoff,this.nodes.delay.delayTime.value=this.options.delayTime,this.nodes.feedback.gain.value=this.options.feedback,this.nodes.filter.frequency.value=this.options.cutoff,this.nodes.filter.type="lowpass"}};Object.defineProperty(ee,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Pt});Object.defineProperty(ee,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:Pt,mix:1,dryGain:1e-4,wetGain:1,feedback:.1,delayTime:.3,maxDelayTime:1,cutoff:2e4}});var Et="DynamicsCompressorInsert",Ds=["threshold","knee","ratio","attack","release"],Ns={id:Et,threshold:-24,knee:30,ratio:12,attack:.003,release:.25},te=class r{get id(){return this.options.id}get input(){return this.node}get output(){return this.node}constructor(e,t={id:Et}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Et}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Ds)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Object.assign(Object.assign({},r.defaultOptions),t),this.node=e.createDynamicsCompressor(),this.updateCompressorNode(),this.automator.add("threshold",this.node.threshold),this.automator.add("ratio",this.node.ratio),this.automator.add("attack",this.node.attack),this.automator.add("release",this.node.release),this.automator.add("knee",this.node.knee)}updateCompressorNode(){this.node.attack.value=x(this.options.attack,cn,dn),this.node.knee.value=x(this.options.knee,fn,hn),this.node.ratio.value=x(this.options.ratio,pn,mn),this.node.release.value=x(this.options.release,gn,bn),this.node.threshold.value=x(this.options.threshold,vn,yn)}};Object.defineProperty(te,"typename",{enumerable:!0,configurable:!0,writable:!0,value:Et});Object.defineProperty(te,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:Ns});var St="GainInsert",Oe=class r{get id(){return this.options.id}get input(){return this.node}get output(){return this.node}constructor(e,t={id:St}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:St}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(["gain"])}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Object.assign(Object.assign({},r.defaultOptions),t),this.node=e.createGain(),this.node.gain.value=this.options.gain,this.automator.add("gain",this.node.gain)}};Object.defineProperty(Oe,"typename",{enumerable:!0,configurable:!0,writable:!0,value:St});Object.defineProperty(Oe,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:St,gain:1}});var At=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"InsertHandlerError"})}},_t=class{constructor(e,t){Object.defineProperty(this,"audioContext",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"bufferRequester",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"insertMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"inserts",{enumerable:!0,configurable:!0,writable:!0,value:[]})}create(e,t){d().debug("[ecas] insert.create",e);let n=Mn(this.audioContext,this.bufferRequester,e,t);return n.isOk()?(this.inserts.unshift(n.value),this.insertMap.set(n.value.id,n.value),f(n.value)):v(n.error)}get(e){return this.insertMap.get(e)}logInserts(){d().log(this.inserts)}has(e){return this.insertMap.has(e)}dispose(){for(this.insertMap.clear();this.inserts.length>0;){let e=this.inserts.pop();e==null||e.input.disconnect(),e==null||e.output.disconnect()}}};var jt="PanInsert",xe=class r{get id(){return this.options.id}get input(){return this.node}get output(){return this.node}constructor(e,t={id:jt}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:jt}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(["pan"])}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"node",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Object.assign(Object.assign({},r.defaultOptions),t),this.node=e.createStereoPanner(),this.node.pan.value=this.options.pan,this.automator.add("pan",this.node.pan)}};Object.defineProperty(xe,"typename",{enumerable:!0,configurable:!0,writable:!0,value:jt});Object.defineProperty(xe,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:{id:jt,pan:0}});var It="PingPongDelayInsert",Cs={id:It,mix:1,dryGain:1e-4,wetGain:1,feedback:.1,delayTimeLeft:.3,delayTimeRight:.3,maxDelayTime:1},Rs=["dry-gain","wet-gain","delay-time-left","delay-time-right","feedback"],re=class r{get id(){return this.options.id}get input(){return this.nodes.input}get output(){return this.nodes.output}constructor(e,t={id:It}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"typename",{enumerable:!0,configurable:!0,writable:!0,value:It}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Rs)}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.options=Ce(r.defaultOptions,t),this.nodes={input:e.createGain(),output:e.createGain(),dry:e.createGain(),wet:e.createGain(),feedback:e.createGain(),delayLeft:e.createDelay(),delayRight:e.createDelay(),channelMerger:e.createChannelMerger()},this.nodes.input.connect(this.nodes.dry),this.nodes.dry.connect(this.nodes.output),this.nodes.delayLeft.connect(this.nodes.channelMerger,0,0),this.nodes.delayRight.connect(this.nodes.channelMerger,0,1),this.nodes.input.connect(this.nodes.delayLeft),this.nodes.delayLeft.connect(this.nodes.delayRight),this.nodes.delayRight.connect(this.nodes.feedback),this.nodes.feedback.connect(this.nodes.delayLeft),this.nodes.channelMerger.connect(this.nodes.wet),this.nodes.wet.connect(this.nodes.output),this.updateDelayOptions(t),this.nodes.dry.gain.value=this.options.dryGain,this.nodes.wet.gain.value=this.options.wetGain,this.automator.add("delay-time-left",this.nodes.delayLeft.delayTime),this.automator.add("delay-time-right",this.nodes.delayRight.delayTime),this.automator.add("dry-gain",this.nodes.dry.gain),this.automator.add("wet-gain",this.nodes.wet.gain),this.automator.add("feedback",this.nodes.feedback.gain)}updateDelayOptions({maxDelayTime:e,delayTimeLeft:t,delayTimeRight:n,feedback:i}){this.options.maxDelayTime=e!==void 0?x(e,0,10):r.defaultOptions.maxDelayTime,this.options.delayTimeLeft=t!==void 0?x(t,0,this.options.maxDelayTime):r.defaultOptions.delayTimeLeft,this.options.delayTimeRight=n!==void 0?x(n,0,this.options.maxDelayTime):r.defaultOptions.delayTimeRight,this.options.feedback=i!==void 0?x(i,1e-4,1):r.defaultOptions.feedback,this.nodes.delayLeft.delayTime.value=this.options.delayTimeLeft,this.nodes.delayRight.delayTime.value=this.options.delayTimeRight,this.nodes.feedback.gain.value=this.options.feedback}};Object.defineProperty(re,"typename",{enumerable:!0,configurable:!0,writable:!0,value:It});Object.defineProperty(re,"defaultOptions",{enumerable:!0,configurable:!0,writable:!0,value:Cs});function Mn(r,e,t,n){switch(d().debug("[ecas] createInsert:",t),t){case J.typename:return f(new J(r,n));case te.typename:return f(new te(r,n));case ee.typename:return f(new ee(r,n));case z.typename:return f(new z(r,n));case Z.typename:return f(new Z(r,n,e));case re.typename:return f(new re(r,n));case Oe.typename:return f(new Oe(r,n));case xe.typename:return f(new xe(r,n));default:{let i=new At(`[ecas] create insert failed to create any insert for, ${t}`);return d().debug(i),v(i)}}}function kn(r,e){let t=r.typename===e;return t||d().warn("[ecas] insert",r==null?void 0:r.typename,"is not of type",e),t}var Ls=["gain","pan"],Tt=class{constructor(e,t,n,i){var s;Object.defineProperty(this,"audioContext",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(Ls)}),Object.defineProperty(this,"inserts",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:"not-setup"}),this.id=n.id;let o=e.createGain();if(o.gain.value=x((s=n.volume)!==null&&s!==void 0?s:1,1e-5,20),this.automator.add("gain",o.gain),n.pan===void 0)this.nodes={gain:o},this.input=o;else{let a=e.createStereoPanner();a.pan.value=x(n.pan,-1,1),a.connect(o),this.automator.add("pan",a.pan),this.input=a,this.nodes={gain:o,pan:a}}this.inserts=new _t(this.audioContext,t);for(let a of this.setupInserts(n))a.mapErr(d().debug);i.connect(this.input)}get output(){return this.nodes.gain}get pannerNode(){return this.nodes.pan}get gainNode(){return this.nodes.gain}get gain(){return this.nodes.gain.gain}get pan(){var e;return(e=this.nodes.pan)===null||e===void 0?void 0:e.pan}setupInserts(e){var t,n;return this.state==="setup"?[]:(this.state="setup",(n=(t=e.inserts)===null||t===void 0?void 0:t.slice().reverse().map(i=>{let{insertType:s}=i,o=K(i,["insertType"]);return s===void 0?v(new Error(`[ecas] cannot add insert to bus "${this.id}" with insertType undefined`)):this.inserts.create(s,o).map(a=>{a.output.connect(this.input),this.input=a.input})}))!==null&&n!==void 0?n:[f(void 0)])}setGain(e,t=0){let n=x(e,1e-5,20);if(t<=0){this.nodes.gain.gain.value=n;return}this.nodes.gain.gain.cancelScheduledValues(0),this.nodes.gain.gain.linearRampToValueAtTime(n,this.audioContext.currentTime+.03+t)}setPan(e,t=0){var n;if(this.nodes.pan===void 0)return;let i=x(e,-1,1);if(t<=0){this.nodes.pan.pan.value=i;return}this.nodes.pan.pan.cancelScheduledValues(0),(n=this.nodes.pan)===null||n===void 0||n.pan.linearRampToValueAtTime(i,this.audioContext.currentTime+.03+t)}dispose(){var e;this.nodes.gain.disconnect(),(e=this.nodes.pan)===null||e===void 0||e.disconnect(),this.inserts.dispose()}};function Vn(r){class e{constructor(u){Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"afters",{enumerable:!0,configurable:!0,writable:!0,value:[]})}}let t={},n=[],i={};r.forEach(a=>{let u=a[0];if(u===void 0)return;let l=String(u),c=t[l];c===void 0&&(c=t[l]=new e(u)),a.forEach(m=>{if(m===u||m===void 0||m===null)return;let p=String(m);t[p]==null&&(t[p]=new e(m)),c!==void 0&&c.afters.push(m)})});let s=Object.keys(t),o=(a,u)=>{let l=t[a];if(l===void 0)return;let c=l.id;if(i[a]!==void 0)return;let m=Array.isArray(u)?u:[];m.push(c),i[a]=!0;for(let p of l.afters){if(m.includes(p))throw new Error(`Circular chain found: ${String(c)} must be before ${String(p)}
                    due to a direct order specification, but ${String(p)} must be before ${String(c)}
                    based on other specifications.`);o(String(p),m.map(h=>h))}n.unshift(c)};return s.forEach(o),n.reverse()}var Dt=class{constructor(e,t,n){var i,s;Object.defineProperty(this,"audioContext",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"bufferRequester",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"buses",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"busConnections",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"constantSourceNode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"connections",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.constantSourceNode=e.createConstantSource(),this.constantSourceNode.offset.value=0,this.constantSourceNode.start();let o=(i=n.find(c=>c.id===$))!==null&&i!==void 0?i:{id:$,destination:oe},a=(s=n.find(c=>c.id===oe))!==null&&s!==void 0?s:{id:oe},u=n.filter(c=>{let m=c.id===oe||c.id===$,p=c.destination===c.id;return p&&d().warn(`[ecas] bus ${c.id} is connected to itself, filtering out`),!(m||p)}),l=[a,o,...u];this.connections=Ms(l);for(let c of this.connections)this.setupBus(c)}setupBus(e){var t,n;let i=new Tt(this.audioContext,this.bufferRequester,e,this.constantSourceNode);if(i.id===oe)return i.output.connect(this.audioContext.destination),this.buses.set(i.id,i),this.busConnections.set(i.id,{inputs:[],outputs:[{index:0,node:this.audioContext.destination,nodeId:i.id+"_0",isUsed:!0}]}),f(void 0);{let s=i.id===$?oe:(t=e.destination)!==null&&t!==void 0?t:"master",o=(n=this.buses.get(s))===null||n===void 0?void 0:n.input;if(this.buses.set(i.id,i),o===void 0)return f(void 0);this.busConnections.set(i.id,{inputs:[],outputs:[{index:0,originalDestinationNode:s,node:o,nodeId:i.id+"_0",isUsed:!0}]}),i.output.connect(o)}return f(void 0)}get(e){return this.buses.get(e)}getBusConnections(e){var t;return(t=this.busConnections.get(e))!==null&&t!==void 0?t:{inputs:[],outputs:[]}}purgeConnections(e,t,n,i){let s=this.getBusConnections(i);s===void 0||s.inputs.length===0||(s.inputs=s.inputs.filter(o=>o.soundContext.id!==e&&o.soundContext.parentId!==t&&o.soundContext.soundSource!==n&&o.soundContext.bussId!==i))}dispose(){for(let e of this.buses.values())e.dispose()}};function Ms(r){let e=r.map(n=>[n.id,n.destination]);return Vn(e).map(n=>r.reduce((i,s)=>i.id===n?i:s))}function Nt(r,e){return Object.assign(Object.assign({},r),{loadrConfig:Object.assign(Object.assign({},r.loadrConfig),{loadPath:e})})}function wr(r,e){return Object.assign(Object.assign({},r),{loadrConfig:Object.assign(Object.assign({},r.loadrConfig),{logger:e})})}function Or(r,e){return Object.assign(Object.assign({},r),{loadrConfig:Object.assign(Object.assign({},r.loadrConfig),{queue:e})})}function xr(r,e){return Object.assign(Object.assign({},r),{loadrConfig:Object.assign(Object.assign({},r.loadrConfig),{pauseOnInvisible:e,resumeOnVisible:e,muteOnInvisible:e,unmuteOnVisible:e})})}function Pr(r,e){return Object.assign(Object.assign({},r),{stateConfig:e})}function Re(r,e){return Object.assign(Object.assign({},r),{soundConfig:e})}function $n(r,e){return Re(r,Object.assign(Object.assign({},r.soundConfig),{buses:e}))}function ks(r,e){return Re(r,Object.assign(Object.assign({},r.soundConfig),{syncers:e}))}function Bs(r,e){return Re(r,Object.assign(Object.assign({},r.soundConfig),{stealers:e}))}function Fs(r,e){return Re(r,Object.assign(Object.assign({},r.soundConfig),{buffers:e}))}function qs(r,e){return Re(r,Object.assign(Object.assign({},r.soundConfig),{containers:e}))}function Er(r,e){return Object.assign(Object.assign({},r),{eventConfig:e})}function Ct(r,e){return Object.assign(Object.assign({},r),{loadrConfig:e})}function Hn(r,e){return Ct(r,Sr(r.loadrConfig,{fileExtToUse:e}))}function Rt(r,e){return{loadrConfig:Sr(r.loadrConfig,e.loadrConfig),soundConfig:Wn(r.soundConfig,e.soundConfig),eventConfig:Jn(r.eventConfig,e.eventConfig),stateConfig:Zn(r.stateConfig,e.stateConfig)}}function Sr(r={},e={}){return Object.assign(Object.assign({},r),e)}function Wn(r={},e={}){return{buffers:Kn(r.buffers,e.buffers),buses:zn(r.buses,e.buses),containers:Qn(r.containers,e.containers),stealers:Xn(r.stealers,e.stealers),syncers:Yn(r.syncers,e.syncers)}}function Xn(r={},e={}){return Object.assign(Object.assign({},r),e)}function Yn(r={},e={}){return Object.assign(Object.assign({},r),e)}function Qn(r={},e={}){return Object.assign(Object.assign({},r),e)}function Kn(r={},e={}){return Object.assign(Object.assign({},r),e)}function zn(r=[],e=[]){return[...new Set([...r,...e])]}function Jn(r=[],e=[]){return[...r,...e]}function Zn(r={},e={}){return Object.assign(Object.assign({},r),e)}function Ar(r,e){var t,n;return Nt(r,`${e}${(n=(t=r==null?void 0:r.loadrConfig)===null||t===void 0?void 0:t.loadPath)!==null&&n!==void 0?n:""}`)}function Us(r,e){var t,n,i,s;if(((n=(t=r==null?void 0:r.soundConfig)===null||t===void 0?void 0:t.buses)===null||n===void 0?void 0:n.some(u=>u.id===$))===!0)return r;let a=[e,...(s=(i=r.soundConfig)===null||i===void 0?void 0:i.buses)!==null&&s!==void 0?s:[]];return $n(r,a)}var yr=class{wrapper(e){return(...n)=>(this._config=e(this._config,...n),this)}constructor(e={}){Object.defineProperty(this,"_config",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"withSoundConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Re)}),Object.defineProperty(this,"withBuses",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper($n)}),Object.defineProperty(this,"withMasterBus",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Us)}),Object.defineProperty(this,"withSyncers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(ks)}),Object.defineProperty(this,"withStealers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Bs)}),Object.defineProperty(this,"withBuffers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Fs)}),Object.defineProperty(this,"withContainers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(qs)}),Object.defineProperty(this,"withEventConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Er)}),Object.defineProperty(this,"withStateConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Pr)}),Object.defineProperty(this,"withLoadrOptions",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Ct)}),Object.defineProperty(this,"withLoadPath",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Nt)}),Object.defineProperty(this,"withPrependLoadPath",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Ar)}),Object.defineProperty(this,"withLogger",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(wr)}),Object.defineProperty(this,"withQueue",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Or)}),Object.defineProperty(this,"withPause",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(xr)}),Object.defineProperty(this,"extendOptions",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Rt)}),Object.defineProperty(this,"extendSoundConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Wn)}),Object.defineProperty(this,"extendBuses",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(zn)}),Object.defineProperty(this,"extendSyncers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Yn)}),Object.defineProperty(this,"extendStealers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Xn)}),Object.defineProperty(this,"extendBuffers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Kn)}),Object.defineProperty(this,"extendContainers",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Qn)}),Object.defineProperty(this,"extendEventConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Jn)}),Object.defineProperty(this,"extendStateConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Zn)}),Object.defineProperty(this,"extendLoadrConfig",{enumerable:!0,configurable:!0,writable:!0,value:this.wrapper(Sr)}),this._config=e}get config(){return this._config}};function ei(r={}){return new yr(r)}var Gs={Filter:J.typename,Compressor:te.typename,AlgorithmicReverb:z.typename,ConvolverReverb:Z.typename,Delay:ee.typename,PingPongDelay:re.typename,Insert:"Insert"};function ti(r){var e,t,n;let i=ei(r),s={id:$,destination:oe};i.withMasterBus(s);let{insertsToAdd:o,updatedEventConfig:a}=Vs((e=i.config.eventConfig)!==null&&e!==void 0?e:[]);if(o.length===0)return i.config;let u=$s((n=(t=i.config.soundConfig)===null||t===void 0?void 0:t.buses)!==null&&n!==void 0?n:[],o);return i.withBuses(u).withEventConfig(a).config}function Vs(r){let e=[],t=[];for(let n of r){let i={id:n.id,actions:[]};for(let s of n.actions)if(s.type.startsWith("busAdd")){let o=Gs[s.type.replace("busAdd","")],a=s.args[0];e.push(Object.assign(Object.assign({},a),{insertType:o==="Insert"?a.typename:o}))}else i={id:n.id,actions:[...i.actions,s]};t=[...t,i]}return{insertsToAdd:e,updatedEventConfig:t}}function $s(r,e){var t;let n=[];for(let i of r){let s=Object.assign({},i);for(let o of e){let{busId:a}=o,u=K(o,["busId"]),l=typeof a=="string"?[a]:a;for(let c of l)i.id===c&&(s=Object.assign(Object.assign({},s),{inserts:[...(t=s.inserts)!==null&&t!==void 0?t:[],u]}))}n=[...n,s]}return n}function _r(r){var e,t;let n=ti(r);for(let i of(t=(e=n.soundConfig)===null||e===void 0?void 0:e.buses)!==null&&t!==void 0?t:[])i.destination===void 0&&(i.destination=$);return Object.assign({atlas:{},soundConfig:{},eventConfig:[],loadrConfig:{},stateConfig:{}},n)}var Pe={min:"min",max:"max",in:"in",out:"out",param:"param",fallback:"fallback"};var Hs="highpass",ri=128,ni=32,ii=16,si={gains:0,pans:0,filters:0};function jr(r,e){let t=r;return e!==void 0&&(t.index=e),t}function Ir(r){return typeof(r==null?void 0:r.index)=="number"}var ze=class r{constructor(e,t={numGains:ri,numPans:ni,numFilters:ii},n={used:Object.assign({},si),created:Object.assign({},si)}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"requestGainNode",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(this.state.used.gains<this.state.created.gains){let s=this.nodes.gains.findIndex(a=>a!==void 0),o=this.nodes.gains[s];if(this.nodes.gains[s]=void 0,o!==void 0)return this.state.used.gains+=1,o.gain.value=o.gain.defaultValue,o}this.state.created.gains>this.properties.numGains&&d().warn("[ecas] out of gain nodes -> increase numGains in config from the current",this.properties.numGains);let i=jr(this.context.createGain(),this.state.created.gains+=1);return this.state.used.gains+=1,i}}),Object.defineProperty(this,"requestPanNode",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(this.state.used.pans<this.state.created.pans){let s=this.nodes.pans.findIndex(a=>a!==void 0),o=this.nodes.pans[s];if(this.nodes.pans[s]=void 0,o!==void 0)return this.state.used.pans+=1,o.pan.value=o.pan.defaultValue,o}this.state.created.pans>this.properties.numPans&&d().warn("[ecas] out of pan nodes -> increase numPans in config from the current",this.properties.numPans);let i=jr(this.context.createStereoPanner(),this.state.created.pans+=1);return this.state.used.pans+=1,i}}),Object.defineProperty(this,"requestFilterNode",{enumerable:!0,configurable:!0,writable:!0,value:()=>{if(this.state.used.filters<this.state.created.filters){let s=this.nodes.filters.findIndex(a=>a!==void 0),o=this.nodes.filters[s];if(this.nodes.filters[s]=void 0,o!==void 0)return this.state.used.filters+=1,o.frequency.value=o.frequency.defaultValue,o.type=Hs,o}this.state.created.filters>this.properties.numFilters&&d().warn("[ecas] out of filter nodes -> increase numFilters in config from the current",this.properties.numFilters);let i=jr(this.context.createBiquadFilter(),this.state.created.filters+=1);return this.state.used.filters+=1,i}}),Object.defineProperty(this,"returnGainNode",{enumerable:!0,configurable:!0,writable:!0,value:i=>{if(!Ir(i)){d().warn("[ecas] NodePool: Non Indexable Gain Node");return}if(this.nodes.gains[i.index]!==void 0){d().warn("[ecas] Returned Existing Gain Node");return}i.gain.cancelScheduledValues(0),i.disconnect(),this.state.used.gains-=1,this.nodes.gains[i.index]=i}}),Object.defineProperty(this,"returnPanNode",{enumerable:!0,configurable:!0,writable:!0,value:i=>{if(!Ir(i)){d().warn("[ecas] NodePool: Non Indexable Pan Node");return}if(this.nodes.pans[i.index]!==void 0){d().warn("[ecas] Returned Existing Pan Node");return}i.pan.cancelScheduledValues(0),i.disconnect(),this.state.used.pans-=1,this.nodes.pans[i.index]=i}}),Object.defineProperty(this,"returnFilterNode",{enumerable:!0,configurable:!0,writable:!0,value:i=>{if(!Ir(i)){d().warn("[ecas] NodePool: Non Indexable Filter Node");return}if(this.nodes.filters[i.index]!==void 0){d().warn("[ecas] Returned Existing Filter Node");return}i.frequency.cancelScheduledValues(0),i.disconnect(),this.state.used.filters-=1,this.nodes.filters[i.index]=i}}),this.nodes={gains:Array.from({length:t.numGains}),pans:Array.from({length:t.numPans}),filters:Array.from({length:t.numFilters})}}static FromContext(e,t={}){var n,i,s;return new r(e,{numFilters:(n=t==null?void 0:t.numFilterNodes)!==null&&n!==void 0?n:ii,numGains:(i=t==null?void 0:t.numGainNodes)!==null&&i!==void 0?i:ri,numPans:(s=t==null?void 0:t.numPanNodes)!==null&&s!==void 0?s:ni})}static Default(){return this.FromContext(new AudioContext({sampleRate:48e3,latencyHint:"playback"}))}};var Dr=()=>{},Ws=Dr,Xs=Dr,Ys=Dr,Qs={value:0},Tr=-1;function Lt(r){let e=!1,t=Tr,n=()=>{},i=new Array,s=0,o=(p,h)=>{i.push(h)},a=()=>{if(!e){e=!0,n!==null&&n();for(let p of i!=null?i:[])p();i.length=0}},u=()=>{t!==Tr&&(clearTimeout(t),t=Tr)},l=()=>{if(r.state==="closed"){u(),c();return}r.state==="running"&&c(),m(s)},c=()=>{r.removeEventListener("statechange",l)},m=p=>{if(s=p!=null?p:0,e){u(),c();return}if(u(),r.state==="running"){let h=(s-r.currentTime)*1e3;if(h<=0){c(),a();return}else t=window.setTimeout(()=>{c(),a()},h);r.addEventListener("statechange",l)}};return{set onended(p){n=p},get onended(){return n},offset:Qs,connect:Ws,disconnect:Xs,start:Ys,stop:m,addEventListener:o}}function Nr(r,e,t,n=()=>{}){let i=Lt(r);i.offset.value=0,i.onended=e,i.connect(r.destination),i.start();try{i.stop(t)}catch(o){d().debug("[ecas] schedule failed to stop source",o)}return()=>{i.onended=n;try{i.stop(),i.disconnect()}catch(o){d().debug("[ecas] schedule failed to stop source",o)}}}var Ks=[.001,.0027825594022071257,.007498942093324555,.020833593247197593,.0562341325190349,.1544346900318837,.4291934260128776,1],zs=[1,.4291934260128776,.1544346900318837,.0562341325190349,.020833593247197593,.007498942093324555,.0027825594022071257,.001,0],Js=[0,.125,.25,.375,.5,.625,.75,.875,1],Zs=[1,.875,.75,.625,.5,.375,.25,.125,0],eo=[0,.19509032201612825,.3826834323650898,.5555702330196022,.7071067811865475,.8314696123025452,.9238795325112867,.9807852804032304,1],to=[1,.9807852804032304,.9238795325112867,.8314696123025452,.7071067811865475,.5555702330196022,.3826834323650898,.19509032201612825,0],oi=new ue(new Error("Cannot Fade Due To Missing Gain Node")),ai=new ue(new Error("Cannot Use Disposed Fader")),Le="exponential",ui={linear:Js,"equal-power":eo,exponential:Ks},li={linear:Zs,"equal-power":to,exponential:zs};function ro(r,e){var t;let n=hr(e)?(t=li[e])!==null&&t!==void 0?t:li.exponential:e,[i,...s]=io(r,n);if(r<=i){let o=no(s)?s:[0];return[r,...o]}return[r,i,...s]}function no(r){return r.length>0}function io(r,e){let t=e.reduce((i,s)=>Math.abs(s-r)<Math.abs(i-r)?s:i),n=e.indexOf(t);return e.slice(n)}var Mt=class r{constructor(e,t,n,i,s=Le,o=Le){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"assetRequester",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"input",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"defaultFadeInCurve",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"defaultFadeOutCurve",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"cancelFadeIn",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cancelFadeOut",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:"init"}),this.input.connect(this.output)}static TryFromOptions(e){let t=e.assetRequester.requestGainNode();if(t===null)return oi;let n=e.assetRequester.requestGainNode();return n===null?(e.assetRequester.returnGainNode(t),oi):f(new r(e.context,e.assetRequester,t,n,e.defaultFadeInCurve,e.defaultFadeOutCurve))}static FromOptions(e){return r.TryFromOptions(e)._unsafeUnwrap()}static Default(){let e=new AudioContext({sampleRate:48e3,latencyHint:"playback"}),t=ze.FromContext(e);return r.FromOptions({context:e,assetRequester:t})}fadeIn({when:e,duration:t,onFadeInEnded:n,curve:i=this.defaultFadeInCurve}){var s;if(this.state==="disposed")return ai;let o=this.input,a=Math.max(e,this.context.currentTime),u=hr(i)?(s=ui[i])!==null&&s!==void 0?s:ui.exponential:i;try{o.gain.setValueCurveAtTime(Float32Array.from(u),a,t)}catch(l){return v(j(l))}return n!==void 0&&(this.cancelFadeIn=Nr(this.context,n,a+t)),f(void 0)}fadeOut({when:e,duration:t,onFadeOutStarted:n,curve:i=this.defaultFadeOutCurve}){if(this.state==="disposed")return ai;let s=this.output,o=Math.max(e,this.context.currentTime),a=s.gain.value;try{s.gain.setValueCurveAtTime(Float32Array.from(ro(a,i)),o,t),n!==void 0&&(this.cancelFadeOut=Nr(this.context,n,o))}catch(u){return v(j(u))}return f(void 0)}connect(e){var t;return this.state==="disposed"?e:(t=this.output.connect(e))!==null&&t!==void 0?t:e}disconnect(){this.state!=="disposed"&&this.output.disconnect()}reset(){this.state!=="disposed"&&(this.cancelFadeIn!==void 0&&(this.cancelFadeIn(),this.cancelFadeIn=void 0),this.cancelFadeOut!==void 0&&(this.cancelFadeOut(),this.cancelFadeOut=void 0),this.input.gain.value=1,this.output.gain.value=1)}dispose(){var e,t;this.state!=="disposed"&&((e=this.cancelFadeIn)===null||e===void 0||e.call(this),(t=this.cancelFadeOut)===null||t===void 0||t.call(this),this.assetRequester.returnGainNode(this.input),this.assetRequester.returnGainNode(this.output),this.state="disposed")}};var Me={value:0,next(){return this.value++}};var so={strategy:"random-standard",avoidRepeatingLast:1,weights:[]},Je=class{constructor(e={},t={}){Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.properties=Object.assign(Object.assign({},so),e),this.state=Object.assign({previous:[],currentIndex:-1},t)}nextIndex(e=this.properties.weights){if(e.length===0)return-1;if(e.length===1)return 0;switch(this.properties.strategy){case"sequence-restart":return this.state.currentIndex=(this.state.currentIndex+1)%e.length,this.state.currentIndex;case"sequence-repeat-last-voice":return this.state.currentIndex===e.length-1?this.state.currentIndex:(this.state.currentIndex=(this.state.currentIndex+1)%e.length,this.state.currentIndex);case"sequence-reverse":return this.state.currentIndex=(this.state.currentIndex-1)%e.length,this.state.currentIndex<0&&(this.state.currentIndex=e.length-1),this.state.currentIndex;case"random-standard":{let i=n(e),s=e.length>this.properties.avoidRepeatingLast+1;return this.properties.avoidRepeatingLast>0&&s&&this.state.previous.slice(-this.properties.avoidRepeatingLast).includes(i)?this.nextIndex(e):(this.state.previous.push(i),i)}default:{this.state.currentIndex=(this.state.currentIndex+1)%e.length;let i=n(e);if(this.state.previous.length>=e.length&&this.state.previous.splice(0),this.state.previous.includes(i)){let s=e.map((a,u)=>this.state.previous.includes(u)?0:a),o=n(s);return this.state.previous.push(o),o}return this.state.previous.push(i),i}}function n(i){let s=i.map(c=>Math.max(1e-4,c)),o=s.reduce((c,m)=>c+m,0),u=s.map(c=>c/o).reduce((c,m)=>[...c,c[c.length-1]+m],[0]).splice(1),l=Math.random();return Math.min(u.findIndex(c=>c>l),i.length-1)}}reset(){this.state.currentIndex=-1,this.state.previous.splice(0)}};var kt=class{constructor(e){Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"randomizer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"weights",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.weights=e.voices.map(t=>{var n;return(n=t.weight)!==null&&n!==void 0?n:50}),this.randomizer=new Je(e)}get nextValue(){let e=this.randomizer.nextIndex(this.weights),t=this.properties.voices[e];if(t===void 0)throw new Error(`Voice ${e} does not exist`);return t.value}};function ci(r){return Array.isArray(r)&&r.length===2&&typeof r[0]=="number"&&typeof r[1]=="number"}function oo(r){return typeof r=="number"||ci(r)}function ao(r){return Array.isArray(r)&&r.length>=1&&r.every(oo)}function uo(r){return ci(r)?lo(...r):r}function fe(r){return typeof r=="number"?r:di(r)}function di(r){let e=r.map(n=>({value:n})),t=new kt({voices:e});return uo(t.nextValue)}function Ge(r){let e={};for(let[t,n]of Object.entries(r))e[t]=ao(n)?di(n):n;return e}function lo(r,e){if(r>e){let t=r;r=e,e=t}return Math.random()*(e-r)+r}var U;(function(r){r[r.Success=0]="Success",r[r.Failure=1]="Failure",r[r.AlreadyPaused=2]="AlreadyPaused",r[r.AlreadyRunning=3]="AlreadyRunning",r[r.ItemUndefined=4]="ItemUndefined"})(U||(U={}));var Ve=[],fi=8,hi=1024,co=2147483646e-3;function fo(r,e=hi-Ve.length){for(let t=0;t<e;t++){let n=Lt(r);n.offset.value=0,n.connect(r.destination);let{promise:i,resolve:s,reject:o}=Qe(),a={source:n,promise:i,resolve:s,reject:o,isPaused:!1,isDone:!1,timeAtPause:-1,timeAtResume:-1,duration:-1,id:Me.next(),timeAtSchedule:-1,whenToStop:-1,fn:()=>{}};a.source.onended=()=>{a.fn(),a.isDone=!0,a.resolve()},Ve.push(a)}return Ve}function Cr(r,e=64){fo(r,e);let t=window.setTimeout(()=>{Ve.length>=hi?window.clearTimeout(t):Cr(r,e)},100)}function ho(r){return Ve.length<fi&&Cr(r),Ve.pop()}var Ze=class{constructor(e){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"nextId",{enumerable:!0,configurable:!0,writable:!0,value:(()=>{let t=0;return()=>t++})()}),Ve.length<fi&&Cr(e)}schedule(e,t){let n=this.context.currentTime,i=Math.max(t-n,.001),s=n+i,o=ho(this.context);o.whenToStop=s,o.duration=i,o.timeAtSchedule=n,o.fn=e,this.items.set(o.id,o),o.source.addEventListener("ended",()=>{this.items.delete(o.id)},{once:!0}),o.source.start();try{o.source.stop(s)}catch(a){d().debug("[ecas] scheduler failed to stop source",a)}return o.id}pause(e){d().debug("[ecas] scheduler pausing",e);let t=s=>{if(s.isPaused||s.isDone)return U.AlreadyPaused;s.isPaused=!0,s.timeAtPause=this.context.currentTime;try{s.source.stop(co)}catch(o){d().debug("[ecas] scheduler failed to stop source",o)}return U.Success};return e===void 0?[...this.items.values()].map(t).every(s=>s===U.Success)?U.Success:U.Failure:(s=>{let o=this.items.get(s);return o===void 0?U.ItemUndefined:t(o)})(e)}resume(e){let{debug:t}=d();t("[ecas] scheduler resuming",e);let n=o=>{if(!o.isPaused||o.isDone)return U.AlreadyRunning;o.isPaused=!1,o.timeAtResume=this.context.currentTime,o.whenToStop=o.timeAtSchedule+o.duration+o.timeAtResume-o.timeAtPause;try{o.source.stop(o.whenToStop)}catch(a){t("[ecas] scheduler failed to stop source",a)}return U.Success};return e===void 0?[...this.items.values()].map(n).every(o=>o===U.Success)?U.Success:U.Failure:(o=>{let a=this.items.get(o);return a===void 0?U.ItemUndefined:n(a)})(e)}cancel(e){let t=s=>{this.items.delete(s.id),s.isDone=!0,s.source.onended=null;try{s.source.stop()}catch(o){d().debug("[ecas] scheduler failed to stop source",o)}return U.Success};return e===void 0?(this.items.forEach(t),U.Success):(s=>{let o=this.items.get(s);return o===void 0?U.ItemUndefined:t(o)})(e)}};var Bt=class extends De{constructor(e,t){super(),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"scheduledDispatches",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"scheduler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.scheduler=t!=null?t:new Ze(e)}scheduleDispatch(e,t,n){let i=()=>{this.dispatch(e,t)},s=this.scheduler.schedule(i,n),o=this.scheduledDispatches.get(e);return this.scheduledDispatches.set(e,o!==void 0?[...o,s]:[s]),s}pauseScheduledDispatch(e){this.scheduler.pause(e)}resumeScheduledDispatch(e){this.scheduler.resume(e)}cancelScheduledDispatch(e){this.scheduler.cancel(e)}pauseScheduledDispatchesByType(e){this.runForType(e,t=>{this.scheduler.pause(t)})}resumeScheduledDispatchesByType(e){this.runForType(e,t=>{this.scheduler.resume(t)})}cancelScheduledDispatchesByType(e){this.runForType(e,t=>{this.scheduler.cancel(t)}),this.scheduledDispatches.set(e,[])}async waitForDispatch(e,t){return await new Promise((n,i)=>{if((t==null?void 0:t.maxWaitTime)!==void 0){let s=()=>{i(new Error("[ecas] waiting for event dispatch took too long"))};this.scheduler.schedule(s,this.context.currentTime+t.maxWaitTime)}this.addEventListener(e,s=>{n(s)},{once:!0})})}runForType(e,t){(i=>{let s=this.scheduledDispatches.get(i);return s!==void 0?s:[]})(e).forEach(t)}dispose(){for(let[,e]of this.scheduledDispatches){for(let t of e)this.scheduler.cancel(t);this.scheduledDispatches.clear(),this.map.clear()}}};var Rr=50,Ft=class{constructor(e,t={}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new mt}),Object.defineProperty(this,"updateLastStartTime",{enumerable:!0,configurable:!0,writable:!0,value:(n=this.context.currentTime)=>{Object.assign(this.state,{lastStartTime:n})}}),this.properties=Object.assign({maxVoices:Number.MAX_SAFE_INTEGER,initialDelay:0,fadeOut:.1,strategy:"kill-oldest",minTimeBetween:0,name:"default"},t),this.state={lastStartTime:-Number.MAX_SAFE_INTEGER}}numberToKill(){return this.queue.items.length-this.properties.maxVoices}setProperties(e){Object.assign(this.properties,e)}add(e,t=!1,n=this.context.currentTime){let i=()=>{for(this.queue.enqueue(Object.assign(e,{priority:e.properties.priority}));this.numberToKill()>0;){let a=this.queue.items.filter(l=>l.priority===this.queue.lowestPriority),u=this.properties.strategy==="kill-oldest"?a[0]:a[a.length-1];if(u===void 0)break;M`[ecas] stealer ${this.properties.name} stealing id: ${u.properties.id}`,this.queue.removeByPredicate(({properties:l})=>l.id===u.properties.id),u.stop({initialDelay:this.properties.initialDelay,fadeOut:this.properties.fadeOut})}},s=!1,o=()=>{s||(this.queue.removeByPredicate(({properties:a})=>a.id===e.properties.id),s=!0)};e.target.addEventListener("cancelled",o,{once:!0}),e.target.addEventListener("ended",o,{once:!0}),t?i():e.target.addEventListener("started",i,{once:!0}),this.updateLastStartTime(n)}canPlay(e=Rr,t=this.context.currentTime){return this.properties.maxVoices<=0||t-this.state.lastStartTime<this.properties.minTimeBetween?!1:e>this.queue.lowestPriority?!0:e===this.queue.lowestPriority?this.properties.strategy==="kill-oldest"?!0:this.currentlyPlaying<this.properties.maxVoices:!1}get currentlyPlaying(){return this.queue.items.length}};var po={Ended:"ended"},ne;(function(r){r[r.Success=0]="Success",r[r.NoBuffer=1]="NoBuffer",r[r.NoDestination=2]="NoDestination",r[r.AlreadyPlayed=3]="AlreadyPlayed",r[r.UnknownError=4]="UnknownError",r[r.NoBeatSyncer=5]="NoBeatSyncer",r[r.VoiceLimitReached=6]="VoiceLimitReached"})(ne||(ne={}));var mo=["Success","NoBuffer","NoDestination","AlreadyPlayed","UnknownError","NoBeatSyncer","VoiceLimitReached"];function Ut(r){return mo[r]}var bo="buffer",ke=.001;function Lr(r){return new Bt(r)}var go=["gain","pan","detune","playbackRate","lowpass","highpass"],qt=class{constructor(e){var t;Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onProperties",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggerOnPropertyCallback",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"assetRequester",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"automator",{enumerable:!0,configurable:!0,writable:!0,value:new C(go)}),Object.defineProperty(this,"target",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"source",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pan",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowPass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"highPass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"connections",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"nodeGraph",{enumerable:!0,configurable:!0,writable:!0,value:[]});let{properties:n,state:i,context:s,assetRequester:o,triggerOnPropertyCallback:a}=e;this.properties=Object.assign({id:(t=n==null?void 0:n.id)!==null&&t!==void 0?t:Me.next(),name:bo,disposeWhenEnded:!0,priority:Rr},n),this.state=Object.assign({hasStopped:!1,hasScheduled:!1,hasCanceled:!1,hasEnded:!1,hasStarted:!1,startedDispatch:0,isDisposed:!1,stopTime:0},i),this.triggerOnPropertyCallback=a,this.onProperties={},this.context=s,this.assetRequester=o,this.target=Lr(s),this.source=this.context.createBufferSource(),this.nodeGraph.push(this.source),this.automator.add("detune",this.source.detune),this.automator.add("playbackRate",this.source.playbackRate),this.last=this.source}get output(){return this.last}connect(e){return this.state.isDisposed?e:(this.connections.push(e),this.last.connect(e))}disconnect(){this.last.disconnect(),this.connections.length=0}play(e={}){var t,n,i;let{log:s,debug:o}=d();if(o("[ecas] buffer play",this.properties.name,"with options:",e),this.state.hasScheduled||this.state.isDisposed)return ne.AlreadyPlayed;try{let{envelopes:a,tempo:u,beatSync:l,lowpass:c,highpass:m,gain:p,pan:h,duration:g,priority:O=this.properties.priority,detune:S=0,playbackRate:B=1,loop:D=!1,loopEnd:N=-1,loopStart:_=0,when:Y=this.context.currentTime,offset:Q=0,fadeIn:F=0,fadeOut:R=0,destinationName:ce="master",sourceName:V="default",syncerName:pe="default",stealerName:Ae="default",stealEvent:E="started",initialDelay:L=0,beatSyncOffset:ie=0,reverse:me=!1,resync:q=!1}=Ge(e);this.onProperties={onCancelled:e.onCancelled,onEnded:e.onEnded,onFadeInEnded:e.onFadeInEnded,onFadeOutStarted:e.onFadeOutStarted,onScheduled:e.onScheduled,onStarted:e.onStarted,onStopped:e.onStopped};let w=pi(B),A=this.assetRequester.requestDestination(ce),_e=me?this.assetRequester.requestBufferReversed(V):this.assetRequester.requestBuffer(V);if(_e===null)return o("[ecas] playback-error: no buffer for buffer:",this.properties.name),this.target.dispatch("error",this.properties),ne.NoBuffer;if(A===null)return o("[ecas] playback-error: no destination for buffer:",this.properties.name),this.target.dispatch("error",this.properties),ne.NoDestination;let or=l!==void 0,je=or?this.assetRequester.requestSyncer(pe):null;if(or&&je===null)return o("[ecas] playback-error: no beatSyncer for buffer:",this.properties.name),this.target.dispatch("error",this.properties),ne.NoBeatSyncer;let ar=Y+L;q&&(je==null||je.resync(ar),u!==void 0&&(je==null||je.setTempo(u)));let ae=or?je.getSyncTime(l,ar,ie,u):Math.max(this.context.currentTime,ar),$e=this.assetRequester.requestStealer(Ae);if(($e==null?void 0:$e.canPlay(O,ae))===!1)return o("[ecas] playback-error: voice-limit reached for buffer:",this.properties.name),this.target.dispatch("error",this.properties),ne.VoiceLimitReached;this.properties.priority=O;let Qi=ae-this.context.currentTime,Ki=E==="scheduled"||Qi<ke;$e==null||$e.add(this,Ki,ae);let Qr=g!=null?g:_e.duration/w-Q,zi=F>ke,Ji=R>ke&&Qr>ke;if(p!==void 0&&this.useGain(p),h!==void 0&&this.usePan(h),c!==void 0&&this.useLowpass(c),e.highpass!==void 0&&this.useHighpass(m),this.connect(A),this.source.playbackRate.value=w,this.source.detune.value=S,this.source.loop=D,this.source.loopStart=_,this.source.loopEnd=N,this.source.loopEnd=_!==0&&N===-1?_e.duration:N,this.source.buffer=_e,this.source.addEventListener(po.Ended,()=>{var se,be;this.state.hasStarted?(this.target.dispatch("ended",this.properties),this.onProperties.onEnded!==void 0&&((se=this.triggerOnPropertyCallback)===null||se===void 0||se.call(this,this.onProperties.onEnded))):(this.state.startedDispatch!==-1&&this.target.cancelScheduledDispatch(this.state.startedDispatch),this.target.dispatch("cancelled",this.properties),o("[ecas] buffer cancel successful for buffer",this.properties.name),this.state.hasCanceled=!0,this.onProperties.onCancelled!==void 0&&((be=this.triggerOnPropertyCallback)===null||be===void 0||be.call(this,this.onProperties.onCancelled))),this.state.hasEnded=!0,this.properties.disposeWhenEnded&&this.dispose()},{once:!0}),zi){let se={duration:F,when:ae,curve:e.fadeInCurve},be=this.onProperties.onFadeInEnded;be!==void 0&&(se.onFadeInEnded=()=>{var He;(He=this.triggerOnPropertyCallback)===null||He===void 0||He.call(this,be)}),(t=this.getFader())===null||t===void 0||t.fadeIn(se)}if(Ji){let se=ae+Qr-R-ke,be={duration:R,when:se,curve:e.fadeOutCurve},He=this.onProperties.onFadeOutStarted;He!==void 0&&(be.onFadeOutStarted=()=>{var ur;(ur=this.triggerOnPropertyCallback)===null||ur===void 0||ur.call(this,He)}),(n=this.getFader())===null||n===void 0||n.fadeOut(be)}g===void 0?this.source.start(ae,Q):this.source.start(ae,Q,g),this.state.stopTime=ae+(g!=null?g:Number.MAX_SAFE_INTEGER),this.state.hasScheduled=!0,this.target.dispatch("scheduled",this.properties),this.onProperties.onScheduled!==void 0&&((i=this.triggerOnPropertyCallback)===null||i===void 0||i.call(this,this.onProperties.onScheduled)),this.target.addEventListener("started",()=>{var se;o("[ecas] buffer started:",this.properties.name),this.state.hasStarted=!0,this.onProperties.onStarted!==void 0&&((se=this.triggerOnPropertyCallback)===null||se===void 0||se.call(this,this.onProperties.onStarted))},{once:!0}),ae-ke>this.context.currentTime?this.state.startedDispatch=this.target.scheduleDispatch("started",this.properties,ae-ke):(this.target.dispatch("started",this.properties),this.state.startedDispatch=-1),a!==void 0&&this.applyEnvelopes(Object.assign(Object.assign({},a),{when:ae}))}catch(a){return s("[ecas] playback-error for buffer:",this.properties.name,a),this.target.dispatch("error",this.properties),ne.UnknownError}return ne.Success}applyEnvelopes(e){var t,n,i,s,o,a;if(this.state.isDisposed)return;let{debug:u}=d();if(u("[ecas] buffer applyEnvelope",this.properties.name,e),this.state.hasEnded||this.state.isDisposed){u("[ecas] buffer already ended, returning early",this.properties.name);return}this.state.hasScheduled||u("[ecas] applying envelope to buffer that has not been scheduled yet. Detune and playbackRate can not be applied.",this.properties.name);let{detune:l,gain:c,pan:m,playbackRate:p,lowpass:h,highpass:g,when:O=this.context.currentTime,initialDelay:S=0,beatSync:B,syncerName:D="default",beatSyncOffset:N=0}=Ge(e),_=B!==void 0,Y=_?this.assetRequester.requestSyncer(D):null;_&&Y===null&&(u(`[ecas] buffer-apply-envelope-error: no beatsyncer for buffer apply envelope to buffer ${this.properties.name}`),this.target.dispatch("error",this.properties));let Q=O+S,F=_&&Y!==null?Y.getSyncTime(B,Q,N):Math.max(this.context.currentTime,Q),R={context:this.context,automator:this.automator};if(p!==void 0&&this.state.hasScheduled){let ce=Object.assign(Object.assign({},p),{points:p.points.map(vo)});we(Object.assign(Object.assign(Object.assign({},R),ce),{when:F,initialDelay:S+((t=ce.initialDelay)!==null&&t!==void 0?t:0),paramId:"playbackRate"}))}l!==void 0&&this.state.hasScheduled&&we(Object.assign(Object.assign(Object.assign({},R),l),{when:F,initialDelay:S+((n=l.initialDelay)!==null&&n!==void 0?n:0),paramId:"detune"})),c!==void 0&&(this.useGain(),we(Object.assign(Object.assign(Object.assign({},R),c),{when:F,initialDelay:S+((i=c.initialDelay)!==null&&i!==void 0?i:0),paramId:"gain"}))),m!==void 0&&(this.usePan(),we(Object.assign(Object.assign(Object.assign({},R),m),{when:F,initialDelay:S+((s=m.initialDelay)!==null&&s!==void 0?s:0),paramId:"pan"}))),h!==void 0&&(this.useLowpass(),we(Object.assign(Object.assign(Object.assign({},R),h),{when:F,initialDelay:S+((o=h.initialDelay)!==null&&o!==void 0?o:0),paramId:"lowpass"}))),g!==void 0&&(this.useHighpass(),we(Object.assign(Object.assign(Object.assign({},R),g),{when:F,initialDelay:S+((a=g.initialDelay)!==null&&a!==void 0?a:0),paramId:"highpass"})))}stop(e={}){var t,n;let{debug:i}=d();if(i("[ecas] buffer stop",this.properties.name,"with options",e),this.state.hasEnded||this.state.isDisposed){i("[ecas] buffer stop called after already ended. Returning early.",this.properties.name);return}let{when:s=this.context.currentTime,fadeOut:o=0,initialDelay:a=0,envelopes:u,beatSync:l,syncerName:c="default",beatSyncOffset:m=0}=Ge(e),p=l!==void 0,h=p?this.assetRequester.requestSyncer(c):null;p&&h===null&&(i(`[ecas] buffer-stop-error: no beatsyncer for stop buffer ${this.properties.name}`),this.target.dispatch("error",this.properties));let g=s+a,O=p&&h!==null?h.getSyncTime(l,g,m):Math.max(this.context.currentTime,g),S=O+o;this.state.stopTime=S,o>ke&&((t=this.getFader())===null||t===void 0||t.fadeOut({when:O,duration:o,curve:e.fadeOutCurve})),u!==void 0&&this.applyEnvelopes(Object.assign(Object.assign({},u),{when:O}));try{this.source.stop(S),this.onProperties.onStopped!==void 0&&((n=this.triggerOnPropertyCallback)===null||n===void 0||n.call(this,this.onProperties.onStopped))}catch(B){return}this.state.hasStopped=!0,this.target.dispatch("stopped",this.properties)}insertNode(e,t){if(this.state.isDisposed)return e;let n=this.last,i=t!=null?t:e;for(let s of this.connections){try{n.disconnect(s)}catch(o){d().warn("[ecas] failed to disconnect node")}i.connect(s)}return n.connect(e),this.last=i,this.nodeGraph.push(e),t!==void 0&&this.nodeGraph.push(t),i}useGain(e){if(this.state.isDisposed||this.gain!==void 0)return;let t=this.assetRequester.requestGainNode();t!==null&&(this.gain=this.insertNode(t),this.automator.add("gain",this.gain.gain),e!==void 0&&(this.gain.gain.value=e))}usePan(e){if(this.state.isDisposed||this.pan!==void 0)return;let t=this.assetRequester.requestPanNode();t!==null&&(this.pan=this.insertNode(t),this.automator.add("pan",this.pan.pan),e!==void 0&&(this.pan.pan.value=e))}useLowpass(e){if(this.state.isDisposed||this.lowPass!==void 0)return;let t=this.assetRequester.requestFilterNode();t!==null&&(t.type="lowpass",t.frequency.value=e!=null?e:this.context.sampleRate/2,this.lowPass=this.insertNode(t),this.automator.add("lowpass",t.frequency))}useHighpass(e){if(this.state.isDisposed||this.highPass!==void 0)return;let t=this.assetRequester.requestFilterNode();t!==null&&(t.type="highpass",t.frequency.value=e!=null?e:30,this.highPass=this.insertNode(t),this.automator.add("highpass",t.frequency))}useFader(){if(this.state.isDisposed||this.fader!==void 0)return;let e=Mt.TryFromOptions({assetRequester:this.assetRequester,context:this.context});if(e.isOk()){let t=e.value;this.fader=t,this.insertNode(t.input,t.output)}}getFader(){return(this.state.isDisposed||this.fader===void 0)&&this.useFader(),this.fader}dispose(){var e;if(this.state.isDisposed)return;this.state.isDisposed=!0;let{debug:t}=d();t("[ecas] buffer dispose",this.properties.name);try{this.source.stop()}catch(n){}this.target.dispatch("disposed",this.properties),this.target.dispose();for(let n of this.nodeGraph)n.disconnect();this.returnNodes(),this.nodeGraph.length=0,this.connections.length=0,this.source.buffer=null,Object.assign(this,{triggerOnPropertyCallback:void 0}),this.onProperties={},this.automator.dispose(),(e=this.fader)===null||e===void 0||e.dispose()}returnNodes(){this.gain!==void 0&&(this.assetRequester.returnGainNode(this.gain),this.gain=void 0),this.pan!==void 0&&(this.assetRequester.returnPanNode(this.pan),this.pan=void 0),this.lowPass!==void 0&&(this.assetRequester.returnFilterNode(this.lowPass),this.lowPass=void 0),this.highPass!==void 0&&(this.assetRequester.returnFilterNode(this.highPass),this.highPass=void 0)}};function pi(r){return Math.max(ht?1e-4:0,r)}function vo(r){return typeof r.val=="number"?Object.assign(Object.assign({},r),{val:pi(r.val)}):r}var yo={name:"container",initialDelay:0,strategy:"sequence-restart",avoidRepeatingLast:1,destinationName:"master",detune:0,voices:[]},Gt=class{constructor({player:e,properties:t,state:n}){Object.defineProperty(this,"player",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"randomizer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.player=e,this.properties=Object.assign(Object.assign({},yo),t),this.state=Object.assign({ids:[]},n),this.randomizer=new Je({strategy:this.properties.strategy,avoidRepeatingLast:this.properties.avoidRepeatingLast,weights:this.properties.voices.map(i=>{var s;return(s=i.weight)!==null&&s!==void 0?s:50})})}getNextVoice(e={}){var t,n,i,s,o,a,u,l,c,m,p,h,g;let O=this.randomizer.nextIndex(),S=this.properties.voices[O];if(S===void 0)return v(new Error(`[ecas]: Container: '${this.properties.name}' could not find a voice for voiceIndex: ${O}`));let B=Me.next();this.state.ids.push(B);let D=Ge(S),N=Ge(e),_=Object.assign(Object.assign(Object.assign({},D),N),{id:B,name:(t=D.name)!==null&&t!==void 0?t:this.properties.name,destinationName:(i=(n=N.destinationName)!==null&&n!==void 0?n:D.destinationName)!==null&&i!==void 0?i:this.properties.destinationName,initialDelay:((o=(s=N.initialDelay)!==null&&s!==void 0?s:D.initialDelay)!==null&&o!==void 0?o:0)+fe(this.properties.initialDelay),detune:((u=(a=N.detune)!==null&&a!==void 0?a:D.detune)!==null&&u!==void 0?u:0)+fe(this.properties.detune),fadeInCurve:(l=S.fadeInCurve)!==null&&l!==void 0?l:e.fadeInCurve,fadeOutCurve:(c=S.fadeOutCurve)!==null&&c!==void 0?c:e.fadeOutCurve});return _.lowpass===void 0&&this.properties.lowpass!==void 0&&(_.lowpass=fe(this.properties.lowpass)),_.highpass===void 0&&this.properties.highpass!==void 0&&(_.highpass=fe(this.properties.highpass)),this.properties.gain!==void 0&&(_.gain=((p=(m=N.gain)!==null&&m!==void 0?m:D.gain)!==null&&p!==void 0?p:1)*fe(this.properties.gain)),this.properties.pan!==void 0&&(_.pan=x(((g=(h=N.pan)!==null&&h!==void 0?h:D.pan)!==null&&g!==void 0?g:0)+fe(this.properties.pan),-1,1)),f(_)}play(e={initialDelay:0}){let t=this.getNextVoice(e);return t.isErr()?(d().log("[ecas] trying to play container",this.properties.name,"when getting next voice returned an error:",t.error),ne.UnknownError):this.player.play(t.value)}stop(e){for(let t of this.state.ids)this.player.stopById(Object.assign({id:t},e))}reset(){this.randomizer.reset()}};var st;(function(r){r[r.INITIAL=0]="INITIAL",r[r.DISPOSED=1]="DISPOSED"})(st||(st={}));var Vt=class{constructor(e){Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"triggerOnPropertyCallback",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new it}),Object.defineProperty(this,"pool",{enumerable:!0,configurable:!0,writable:!0,value:new it}),Object.defineProperty(this,"target",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:st.INITIAL}),Object.defineProperty(this,"onstarted",{enumerable:!0,configurable:!0,writable:!0,value:({detail:t})=>{this.target.dispatch("started",t)}}),Object.defineProperty(this,"onended",{enumerable:!0,configurable:!0,writable:!0,value:({detail:t})=>{this.target.dispatch("ended",t)}}),Object.defineProperty(this,"remover",{enumerable:!0,configurable:!0,writable:!0,value:t=>{let n=!1;return()=>{n||(this.queue.removeByPredicate(i=>i.properties.id===t.properties.id),n=!0)}}}),this.target=Lr(e.context),this.triggerOnPropertyCallback=e.triggerOnPropertyCallback}play(e){var t,{name:n,id:i=Me.next(),priority:s=50}=e,o=K(e,["name","id","priority"]);let a=(t=this.pool.dequeue())!==null&&t!==void 0?t:new qt(this.options);Object.assign(a.properties,{id:i,name:n,priority:s}),a.target.addEventListener("started",this.onstarted,{once:!0}),a.target.addEventListener("ended",this.onended,{once:!0});let u=a.play(o);if(u===ne.Success){this.queue.enqueue(a);let l=this.remover(a);a.target.addEventListener("ended",l,{once:!0}),a.target.addEventListener("cancelled",l,{once:!0})}else u===ne.UnknownError?a.dispose():(d().debug(`[ecas] pool buffer ${a.properties.name}`),a.target.removeEventListener("started",this.onstarted),a.target.removeEventListener("ended",this.onstarted),this.pool.enqueue(a));return u}applyEnvelopeByName({name:e,envelopes:t}){this.selectByName(e).forEach(n);function n(i){i.applyEnvelopes(Object.assign({},t))}}applyEnvelopeById({id:e,envelopes:t}){this.selectById(e).forEach(n);function n(i){i.applyEnvelopes(t)}}applyEnvelopeToAll({envelopes:e}){this.queue.items.forEach(t);function t(n){n.applyEnvelopes(e)}}stopByName(e){this.queue.dequeueByPredicate(t).forEach(n);function t({properties:i}){return i.name===e.name}function n(i){i.stop(e)}}stopById(e){this.queue.dequeueByPredicate(t).forEach(n);function t({properties:i}){return i.id===e.id}function n(i){i.stop(e)}}stopAll(e={}){for(let t of this.queue.drain())t.stop(e)}stopOldest(e={}){var t;(t=this.queue.dequeue())===null||t===void 0||t.stop(e)}stopNewest(e={}){var t;(t=this.queue.dequeueLast())===null||t===void 0||t.stop(e)}selectById(e){return this.queue.items.filter(t=>t.properties.id===e)}selectByName(e){return this.queue.items.filter(t=>t.properties.name===e)}dispose(){if(this.state!==st.DISPOSED){this.state=st.DISPOSED;for(let e of this.queue.drain())e.dispose();this.target.dispose()}}};var $t=class{constructor(e,t={},n={}){Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"properties",{enumerable:!0,configurable:!0,writable:!0,value:{lookAhead:.02,beatsPerBar:4,ticksPerBeat:4,tempo:120}}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:{isRunning:!1,startTime:0}}),dr(this.properties,t),dr(this.state,n)}start(e=this.context.currentTime){d().debug("[ecas] MusicalSyncer started"),this.state.startTime=e,this.state.isRunning=!0}setTempo(e){this.properties.tempo=e}stop(){this.state.isRunning=!1}resync(e=this.context.currentTime){this.start(e)}getSyncTime(e,t,n=0,i=this.properties.tempo){switch(this.state.isRunning||this.start(),e){case"tick":return this.getTickSyncTime(t,i)+n;case"eighth":return this.getEightSyncTime(t,i)+n;case"beat":return this.getBeatSyncTime(t,i)+n;case"bar":return this.getBarSyncTime(t,i)+n;default:return this.getSyncedTime(e,t,i)+n}}getTickSyncTime(e,t=this.properties.tempo){return this.getSyncedTime(this.properties.ticksPerBeat,e,t)}getEightSyncTime(e,t=this.properties.tempo){return this.getSyncedTime(2,e,t)}getBeatSyncTime(e,t=this.properties.tempo){return this.getSyncedTime(1,e,t)}getBarSyncTime(e,t=this.properties.tempo){return this.getSyncedTime(1/this.properties.beatsPerBar,e,t)}getSyncedTime(e,t=0,n=this.properties.tempo){let i=this.context.currentTime,o=Math.max(t,i)-this.state.startTime,a=60/n/e,u=Math.ceil(o/a);return this.state.startTime+u*a+this.properties.lookAhead}},wo={Thirtytwoo:8,Sixteenth1:4,Sixteenth2:2,Sixteenth3:1.3333333333,Sixteenth4:1,Sixteenth5:.8,Sixteenth6:.6666666667,Sixteenth7:.5714285714,Sixteenth8:.5,Sixteenth9:.4444444444,Sixteenth10:.4,Sixteenth11:.3636363636,Sixteenth12:.3333333333333333,Sixteenth13:.3076923077,Sixteenth14:.2857142857,Sixteenth15:.2666666667,Sixteenth16:.25,Eigth1:2,Eigth2:1,Eigth3:.75,Eigth4:.5,Eigth5:.4,Eigth6:.3333333333333333,Eigth7:.2857142857,Eigth8:.25,Beat1:1,Beat2:.5,Beat3:.3333333333333333,Beat4:.25,Bar1:.25,Bar2:.125,Bar3:.08333333333333333,Bar4:.0625,Bar5:.05,Bar6:.041666666666666664,Bar7:.03571428571428571,Bar8:.03125,Bar9:.03125,Bar10:.03125,Bar11:.03125,Bar12:.03125,Bar13:.03125,Bar14:.03125,Bar15:.03125,Bar16:.015625,ThirtytwooTriplet:6,SixteenthTriplet:2.6666666667,EighthTriplet:1.3333333333,BeatTriplet:.6666666667,HalfNote:.5,HalfNoteTriplet:.375,BarTriplet:.1875},od=Object.assign(Object.assign({},wo),{Bar:.3333333333333333,BarTriple:.25,BarTwo:.16666666666666666,BarFour:.08333333333333333,BarEigth:.041666666666666664,BarSixteen:.020833333333333332});var Pd={loadPath:"./encoded/",forcePolyfills:{},fileExtToUse:".webm",preload:!1,pauseOnInvisible:!0,muteOnInvisible:!nn(),resumeOnVisible:!0,unmuteOnVisible:!0,logger:"none",queue:!0,initialMasterVolume:1,defaultFadeInCurve:Le,defaultFadeOutCurve:Le};var Ad={[z.typename]:"reverbAlgorithmic",[Z.typename]:"reverbConvolver",[te.typename]:"compressor",[ee.typename]:"delay",[re.typename]:"pingPongDelay",[J.typename]:"filter"};function bi(r={}){if(typeof AudioContext=="undefined"){if(typeof webkitAudioContext=="undefined")throw new Error("Audio Context is not defined");return new webkitAudioContext(r)}return new AudioContext(r)}function gi(r){return r.getAutoplayPolicy!==void 0}function vi(r){return r!==void 0?r.state==="running":(r=bi(),r.state==="running"?(r.close().catch(),!0):(r.close().catch(),!1))}function mi(r){var e,t;return(r==null?void 0:r.state)==="running"?!0:gi(navigator)?navigator.getAutoplayPolicy("audiocontext")==="allowed":(e=navigator.userActivation)!=null&&e.isActive?!0:(t=navigator.userActivation)!=null&&t.hasBeenActive?vi():!1}function Mr(r,e){let t=-1,n="init";return new Promise(i=>{async function s(o){if(n==="init"){o===void 0&&(o=bi(e));let a=o;return a.resume().then(()=>{clearInterval(t),n==="init"&&(n="resolved",i(a))}).catch(console.warn)}}if(mi(r)){s(r);return}if(!gi(navigator)&&vi()){s(r);return}window.addEventListener("click",()=>{s(r)},{once:!0,capture:!0,passive:!0}),window.addEventListener("touchend",()=>{s(r)},{once:!0,capture:!0,passive:!0}),t=window.setInterval(()=>{if(mi()){s(r);return}},200)})}var xo=[26,69,223,163,159,66,134,129,1,66,247,129,1,66,242,129,4,66,243,129,8,66,130,132,119,101,98,109,66,135,129,4,66,133,129,2,24,83,128,103,1,0,0,0,0,0,2,1,17,77,155,116,186,77,187,139,83,171,132,21,73,169,102,83,172,129,161,77,187,139,83,171,132,22,84,174,107,83,172,129,214,77,187,140,83,171,132,18,84,195,103,83,172,130,1,64,77,187,140,83,171,132,28,83,187,107,83,172,130,1,235,236,1,0,0,0,0,0,0,89,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,21,73,169,102,176,42,215,177,131,15,66,64,77,128,140,76,97,118,102,54,48,46,51,46,49,48,48,87,65,140,76,97,118,102,54,48,46,51,46,49,48,48,68,137,136,64,60,0,0,0,0,0,0,22,84,174,107,229,174,1,0,0,0,0,0,0,92,215,129,1,115,197,136,138,87,207,235,92,22,242,91,156,129,0,34,181,156,131,117,110,100,136,129,0,134,134,65,95,79,80,85,83,86,170,131,99,46,160,86,187,132,4,196,180,0,131,129,2,225,145,159,129,1,181,136,64,231,112,0,0,0,0,0,98,100,129,16,99,162,147,79,112,117,115,72,101,97,100,1,1,56,1,128,187,0,0,0,0,0,18,84,195,103,252,115,115,159,99,192,128,103,200,153,69,163,135,69,78,67,79,68,69,82,68,135,140,76,97,118,102,54,48,46,51,46,49,48,48,115,115,215,99,192,139,99,197,136,138,87,207,235,92,22,242,91,103,200,161,69,163,135,69,78,67,79,68,69,82,68,135,148,76,97,118,99,54,48,46,51,46,49,48,48,32,108,105,98,111,112,117,115,103,200,162,69,163,136,68,85,82,65,84,73,79,78,68,135,148,48,48,58,48,48,58,48,48,46,48,50,56,48,48,48,48,48,48,0,0,31,67,182,117,165,231,129,0,163,139,129,0,0,128,8,11,230,59,35,171,96,160,147,161,138,129,0,21,0,8,8,172,179,14,198,117,162,132,0,205,254,96,28,83,187,107,145,187,143,179,129,0,183,138,247,129,1,241,130,1,193,240,129,3];function Po(r){return async e=>{try{return(await r.decodeAudioData(Uint8Array.from(e).buffer)).numberOfChannels===1}catch(t){return!1}}}async function yi(r){return await Po(r)(xo)}var he={Ready:"ecas-ready",Mute:"ecas-mute",Unmute:"ecas-unmute",Pause:"ecas-pause",Resume:"ecas-resume",Timer:{Pause:"ecas-timer-pause",Resume:"ecas-timer-resume"},Context:{Pause:"ecas-context-pause",Resume:"ecas-context-resume",Suspended:"ecas-context-suspended",Running:"ecas-context-running",Closed:"ecas-context-closed",Interrupted:"ecas-context-interrupted"},Preload:{Start:"ecas-preload-start",Done:"ecas-preload-done",Progress:"ecas-preload-progress"},Sound:{LoadStart:"ecas-sound-load-start",Loading:"ecas-sound-load-loading",LoadDone:"ecas-sound-load-done",LoadError:"ecas-sound-load-error",Abort:"ecas-sound-abort",CanPlay:"ecas-sound-canplay",Play:"ecas-sound-play",Stop:"ecas-sound-stop",Ended:"ecas-sound-ended",Pause:"ecas-sound-pause",FadeOutStart:"ecas-sound-fade-out-start",FadeOutEnd:"ecas-sound-fade-out-end",PlaybackStart:"ecas-sound-playback-start",PlaybackEnd:"ecas-sound-playback-end",PlaybackError:"ecas-sound-playback-error"},Events:{LoadStart:"ecas-events-load-start",LoadDone:"ecas-events-load-done"},Envelope:{Play:"ecas-envelope-play",Start:"ecas-envelope-start",Ended:"ecas-envelope-ended"}};var Ht=class{constructor(){Object.defineProperty(this,"record",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}on(e,t){let n=this.record.get(e);n!==void 0?n.push(t):this.record.set(e,[t])}off(e,t){let n=this.record.get(e);if(n===void 0)return d().error(`[ecas] cannot remove event: ${e} since it does not exist`),!1;let i=n.filter(s=>s!==t);return i.length!==n.length?(this.record.set(e,i),!0):!1}emit(e,...t){let n=this.record.get(e);if(n!==void 0)for(let i of n)try{i(...t)}catch(s){d().debug(`[ecas] error in callback for event ${e}`,s)}}dispose(){this.record.clear()}};var ot="genesis",kr={name:ot,parent:"",events:{}},Wt=class{constructor(e,t,n,i){var s,o;t===void 0&&(t={genesis:kr}),n===void 0&&(n=Oi(new Map,(s=t[ot])!==null&&s!==void 0?s:kr)),i===void 0&&(i=(o=n.get(So(n,e)))!==null&&o!==void 0?o:kr),Object.defineProperty(this,"stateConfig",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"states",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"active",{enumerable:!0,configurable:!0,writable:!0,value:i});let{table:a}=d();a("[ecas] states:"),a([...this.states.keys()]),typeof window!="undefined"&&window.addEventListener("unload",()=>{Ao(this.active.name)},{once:!0})}triggerStateChange(e,t=[]){if(this.active.deactivatesOn!==void 0&&wi(this.active.deactivatesOn,e,t)&&this.changeState(this.active.parent),this.active.children===void 0)return this.active;for(let[n,i]of Object.entries(this.active.children))if(i.activatesOn!==void 0&&wi(i.activatesOn,e,t))return this.changeState(`${this.active.name}::${n}`);return this.active}changeState(e){var t;return d().debug(`[ecas] moving to state ${e}`),this.active=(t=this.states.get(e))!==null&&t!==void 0?t:this.active}readState(){return xi().andThen(e=>{var t;return this.active=(t=this.states.get(e))!==null&&t!==void 0?t:this.active,f(this.active)})}};function Oi(r,e,t,n,i=ot){var s;let o=e.children;if(i=t!==void 0?`${i}::${t}`:i,r=Eo(r,i,e,n),o!==void 0)for(let[a,u]of Object.entries(o))r=Oi(r,u,a,i,i);return i=i.slice(0,i.length-((s=t==null?void 0:t.length)!==null&&s!==void 0?s:0)-2),r}function Eo(r,e,t,n){var i;if(r.has(e))return d().debug("[ecas] cannot add the state since it already exist on the same level.."),r;let s=Object.assign(Object.assign({},t),{events:(i=t.events)!==null&&i!==void 0?i:{},name:e,parent:n!=null?n:"none"});if(n===void 0)return r.set(e,s);let o=r.get(n);return o===void 0?(d().debug(`[ecas] tried to set state with "${n}" but it does not exist on name: ${e}`),r):(Object.assign(s.events,Object.assign(Object.assign({},o.events),s.events)),r.set(e,s))}function So(r,e){return e!==void 0&&r.has(e)?(M`[ecas] initial state from loader config ${e}`,e):xi().match(t=>r.has(t)?t:ot,()=>ot)}function wi(r,e,t=[]){return r.some(n=>typeof n=="string"?n===e:n.event===e&&n.values.every(i=>t.includes(i)))}function Ao(r){d().debug("[ecas] save state to localstorage",r);let e="ECAS_AUDIO_STATE";try{return typeof localStorage=="undefined"?I("[ecas] localStorage is undefined"):(localStorage.setItem(e,r),f(void 0))}catch(t){return wn(t)}}function xi(){let{debug:r}=d();r("[ecas] read state from localstorage");try{if(typeof localStorage=="undefined")return I("[ecas] localStorage is undefined");let e=localStorage.getItem("ECAS_AUDIO_STATE");return e===null?I("[ecas] no state saved in localstorage"):f(e)}catch(e){return I(`[ecas] failed to read from localstorage: ${j(e).message}`)}}function et(r){if(Ue(r))return r;let e=!0,t=/^-?\d*\.?\d+,-?\d*\.?\d+$/,n=/^-?\d*\.?\d+$/,i,s;if(!Ue(r)&&Array.isArray(r))if(r.length>0){if(s=r.map(o=>{if(n.test(o))return o;if(Ye(o))return Pi(parseFloat(o[0]),parseFloat(o[1]));if(t.test(o)){let a=o.split(",");return Pi(parseFloat(a[0]),parseFloat(a[1]))}else e=!1,d().warn("[ecas] invalid random value format: "+r);return null}),e)return i=_o(s)[0],parseFloat(i)}else d().warn("[ecas] invalid random value: empty array");else return i=r,i;throw new Error("[ecas] randomize values should not reach this line")}function _o(r){let e=r.map(t=>[Math.random(),t]);return e.sort(),e.map(t=>t[1])}function Pi(r,e){return(Math.random()*(e-r)+r).toFixed(3)}function Xt(r){return ye(r,Pe.in)&&ye(r,Pe.out)?Ue(r[Pe.in])&&Ue(r[Pe.out]):!1}function Si(r){return ye(r,Pe.min)&&ye(r,Pe.max)&&Te(r.min)&&Te(r.max)?Xt(r.min)&&Xt(r.max):!1}function Yt(r){return Te(r)&&ye(r,Pe.param)?ye(r,Pe.param)&&(Xt(r)||Si(r)):!1}function jo(r,e){let t=et(r.min.in),n=et(r.min.out),i=et(r.max.in)-t,s=et(r.max.out)-n,o=(e-t)/i;return s*o+n}function Io(r,e){if(e===r.in)return et(r.out);throw new Error("translateBasic failed")}function To(r,e){if(Xt(r))return Io(r,e);if(Si(r))return jo(r,e);throw new Error("ECAS Translator.translateObject should never reach this line.")}function Ei(r,e){var t,n;let i=(n=(t=e[r.param])!==null&&t!==void 0?t:r.fallback)!==null&&n!==void 0?n:0;if(!Ue(i))throw new Error(`translate only works for numbers but arg is ${typeof i}, args.length: ${e.length}, eventParam: ${r.param}, args: ${e}`);return To(r,i)}function Ai(r,e){let t=sn(r),n=[...e];for(let i=0;i<t.length;i++){let s=t[i];if(Yt(s))t[i]=Ei(s,n);else if(Te(s)){for(let[o,a]of Object.entries(s))if(Yt(a)){let u=t[i];u!==void 0&&(u[o]=Ei(a,n))}}}return t}function _i(r){for(let e=0;e<r.length;e++){let t=r[e];if(Yt(t))return!0;if(Te(t)){for(let[,n]of Object.entries(t))if(Yt(n))return!0}}return!1}var Qt=class extends Ht{constructor(e,t,n,i,s=new Wt(n,t),o=Ii(Object.values(t)),a=Co(e),u=No(s.states,o),l=Do(e)){super(),Object.defineProperty(this,"api",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"stateMachine",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"gameEvents",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"audioEvents",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"actions",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:"running"});let{info:c}=d();c("[ecas] game events:",this.gameEvents),c("[ecas] audio events:",this.audioEvents),c("[ecas] state map:",this.events),c("[ecas] actions:",this.actions)}triggerGameEvent(e,...t){var n,i;let{debug:s,info:o}=d();o(`[ecas] game-event ${e}`,...t);let a=this.api.audioContext;this.state==="running"&&!document.hidden&&(a==null?void 0:a.state)!=="running"&&(a==null||a.resume().catch(s));let u=this.stateMachine.triggerStateChange(e,t),l=(n=this.events.get(u.name))===null||n===void 0?void 0:n.get(e);if(l===void 0)return[];if(typeof l=="string")return this.triggerAudioEvent(l,...t);let c=(i=l[t[0]])!==null&&i!==void 0?i:l.fallback;return c===void 0?[]:this.triggerAudioEvent(c,...t)}triggerAudioEvent(e,...t){d().info(`[ecas] audio-event ${e}`,...t);let n=this.actions.get(e);if(n===void 0)return this.emit(e,...t),[];let i=Array.from({length:n.length});for(let s=0;s<n.length;s++){let o=n[s];i[s]=o.hasTranslation?this.runAction({type:o.type,args:Ai(o.args,t)}):this.runAction(o)}return this.emit(e,...t),i}triggerOnPropertyEventOrAction(e){var t,n;if(this.state==="paused")return[];if(d().debug("[ecas]: calling triggerOnPropertyEventOrAction"),typeof e=="string")return this.triggerAudioEvent(e,[]);if((o=>Array.isArray(o))(e))return e.map(o=>this.runAction(o));let s=[];for(let o of(t=e.audioEvents)!==null&&t!==void 0?t:[])s.push(...this.triggerAudioEvent(o,[]));for(let o of(n=e.gameEvents)!==null&&n!==void 0?n:[])s.push(...this.triggerGameEvent(o,[]));return s}runAction(e){if(this.state==="paused"&&e.type!=="unpause")return f(void 0);let t=this.api[e.type];if(t===void 0){let n=`[ecas] unsupported method ${e.type}`;return d().warn(n),v(new Error(n))}return t.apply(this.api,e.args)}};function Do(r){let e=new Map;for(let t of r){let n=t.actions.map(i=>Object.assign(Object.assign({},i),{hasTranslation:_i(i.args)}));e.set(t.id,n)}return e}function No(r,e){let t=(i,s)=>ji(r,i,s),n=new Map;for(let[i,s]of r.entries()){let o=e.map(u=>t(u,s)),a=new Map;for(let u=0;u<o.length;u++)if(o[u]!==void 0){let l=e[u],c=o[u];l!==void 0&&c!==void 0&&a.set(l,c)}n.set(i,a)}return n}function ji(r,e,t){if(t.events===void 0)return;let n=t.events[e];if(n!==void 0)return n;let i=r.get(t.parent);if(i!==void 0)return ji(r,e,i)}function Co(r){return[...new Set(r.map(e=>e.id)).keys()]}function Ii(r){return en(r.map(e=>{var t,n,i,s;return[...nt((t=e.events)!==null&&t!==void 0?t:{}),...((n=e.activatesOn)!==null&&n!==void 0?n:[]).map(o=>typeof o=="string"?o:o.event),...((i=e.deactivatesOn)!==null&&i!==void 0?i:[]).map(o=>typeof o=="string"?o:o.event),...Ii(Object.values((s=e.children)!==null&&s!==void 0?s:{}))]}).flat())}function Kt(r=Array){let e=!1;return r.prototype.flat===void 0&&(r.prototype.flat=Ro,e=!0),r.prototype.flatMap===void 0&&(r.prototype.flatMap=Lo,e=!0),e}function Ro(r=1){if(r<1)return this;let e=[];for(let t of this)Array.isArray(t)?e.push(...t.flat(r-1)):e.push(t);return e}function Lo(r){return this.map(r).flat()}function Ti(r){var e;let t=(e=r.AudioParam)===null||e===void 0?void 0:e.prototype;if(t===void 0){d().debug("[polyfill]: (AudioParam) no AudioParam.prototype found. Skipping polyfill.");return}!G(t,"cancelAndHoldAtTime")&&G(t,"cancelScheduledValues")&&(d().debug("[polyfill]: (AudioParam) installing cancelAndHoldAtTime"),P(t,"cancelAndHoldAtTime",{value:t.cancelScheduledValues})),G(t,"automationRate")||(d().debug("[polyfill]: (AudioParam) installing automationRate"),P(t,"automationRate",{value:"a-rate"}))}function Di(){typeof AudioContext!="undefined"&&AudioContext.prototype.createConstantSource===void 0&&(AudioContext.prototype.createConstantSource=Mo)}function Mo(){return new Br(this)}var Br=class{constructor(e,t){var n;Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"oscillator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"gainNode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let i=(n=t==null?void 0:t.offset)!==null&&n!==void 0?n:1;this.oscillator=e.createOscillator(),this.oscillator.type="sine",this.oscillator.frequency.value=0,this.gainNode=e.createGain(),this.gainNode.gain.value=i,this.offset=this.gainNode.gain,this.oscillator.connect(this.gainNode)}start(e){this.oscillator.start(e)}stop(e){this.oscillator.stop(e)}addEventListener(e,t,n){this.oscillator.addEventListener(e,t,n)}dispatchEvent(e){return this.oscillator.dispatchEvent(e)}removeEventListener(e,t,n){this.oscillator.removeEventListener(e,t,n)}get channelCount(){return this.oscillator.channelCount}set channelCount(e){this.oscillator.channelCount=e}get channelCountMode(){return this.oscillator.channelCountMode}set channelCountMode(e){this.oscillator.channelCountMode=e}get channelInterpretation(){return this.oscillator.channelInterpretation}set channelInterpretation(e){this.oscillator.channelInterpretation=e}connect(e,t,n){return this.gainNode.connect(e,t,n)}disconnect(e,t,n){e===void 0?this.gainNode.disconnect():this.gainNode.disconnect(e,t,n)}get detune(){return this.oscillator.detune}get frequency(){return this.oscillator.frequency}get numberOfInputs(){return this.oscillator.numberOfInputs}get numberOfOutputs(){return this.oscillator.numberOfOutputs}get onended(){return this.oscillator.onended}set onended(e){this.oscillator.onended=e}};var Be=class{preventDefault(){this.defaultPrevented=!0}composedPath(){return[]}stopImmediatePropagation(){}stopPropagation(){}initEvent(e,t,n){this.type=e,this.bubbles=t!=null?t:!1,this.cancelable=n!=null?n:!1}constructor(e,t){var n,i,s;Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"bubbles",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cancelable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"composed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"currentTarget",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"eventPhase",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"isTrusted",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"returnValue",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"srcElement",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"target",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"timeStamp",{enumerable:!0,configurable:!0,writable:!0,value:Date.now()}),Object.defineProperty(this,"cancelBubble",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"defaultPrevented",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"NONE",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"CAPTURING_PHASE",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"AT_TARGET",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"BUBBLING_PHASE",{enumerable:!0,configurable:!0,writable:!0,value:3}),this.bubbles=(n=t==null?void 0:t.bubbles)!==null&&n!==void 0?n:!1,this.cancelable=(i=t==null?void 0:t.cancelable)!==null&&i!==void 0?i:!1,this.composed=(s=t==null?void 0:t.composed)!==null&&s!==void 0?s:!1,this.type=e}};Object.defineProperty(Be,"NONE",{enumerable:!0,configurable:!0,writable:!0,value:0});Object.defineProperty(Be,"CAPTURING_PHASE",{enumerable:!0,configurable:!0,writable:!0,value:1});Object.defineProperty(Be,"AT_TARGET",{enumerable:!0,configurable:!0,writable:!0,value:2});Object.defineProperty(Be,"BUBBLING_PHASE",{enumerable:!0,configurable:!0,writable:!0,value:3});var zt=class{constructor(e,t={pan:0}){var n;Object.defineProperty(this,"_input",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pan",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"channelCount",{enumerable:!0,configurable:!0,writable:!0,value:2}),Object.defineProperty(this,"channelCountMode",{enumerable:!0,configurable:!0,writable:!0,value:"clamped-max"}),Object.defineProperty(this,"channelInterpretation",{enumerable:!0,configurable:!0,writable:!0,value:"speakers"}),Object.defineProperty(this,"numberOfInputs",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"numberOfOutputs",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"addEventListener",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"dispatchEvent",{enumerable:!0,configurable:!0,writable:!0,value:()=>!0}),Object.defineProperty(this,"removeEventListener",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),Object.defineProperty(this,"isStereoPannerNode",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.context=e,this._input=this.context.createGain(),this._output=this.context.createGain();let i=(n=t.pan)!==null&&n!==void 0?n:0,s=this.context.createChannelSplitter(2),o=this.context.createGain(),a=this.context.createGain(),u=this.context.createGain(),l=this.context.createGain(),c=this.context.createChannelMerger(2),m=this.context.createChannelMerger(2),p=this.context.createChannelMerger(2);this._input.connect(s),s.connect(o,0),s.connect(a,0),s.connect(u,1),s.connect(l,1),o.connect(c,0,0),l.connect(c,0,0),u.connect(m,0,1),a.connect(m,0,1),c.connect(p,0,0),m.connect(p,0,1),p.connect(this._output),this.pan={get value(){return i},set value(h){o.gain.value=1-Math.max(h,0),l.gain.value=-Math.min(h,0),u.gain.value=1+Math.min(h,0),a.gain.value=Math.max(h,0),i=h},get automationRate(){return"a-rate"},get defaultValue(){return 0},get maxValue(){return 1},get minValue(){return-1},cancelAndHoldAtTime:h=>this.pan,cancelScheduledValues:h=>this.pan,exponentialRampToValueAtTime:(h,g)=>(this.pan.value=h,this.pan),linearRampToValueAtTime:(h,g)=>(this.pan.value=h,this.pan),setTargetAtTime:(h,g,O)=>(this.pan.value=h,this.pan),setValueAtTime:(h,g)=>(this.pan.value=h,this.pan),setValueCurveAtTime:(h,g,O)=>(this.pan.value=Number(h[h.length-1]),this.pan)},this.pan.value=i}connect(...e){try{this._output.connect.apply(this._output,e)}catch(t){d().debug(t)}}disconnect(...e){try{this._output.disconnect.apply(this._output,e)}catch(t){d().debug(t)}}toString(){return"StereoPannerNode"}};function Ni(r=window){let e=r.AudioContext.prototype;function t(i,s){return new zt(i,s)}P(e,"createStereoPanner",{value:function(i){return t(this,i)}});let n=r.AudioNode.prototype.connect;P(r.AudioNode.prototype,"connect",{value:function(i,s,o){function a(u){return G(u,"isStereoPannerNode")&&u.isStereoPannerNode===!0}return a(i)&&(i=i._input),n.call(this,i,s!=null?s:0,o!=null?o:0)}}),r.StereoPannerNode===void 0&&(r.StereoPannerNode=zt)}var ko=-34028234663852886e22,Ci=34028234663852886e22,Jt=class{constructor(e){Object.defineProperty(this,"playbackRate",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"rate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_detune",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.rate=e.value,this._detune=0}get automationRate(){return this.playbackRate.automationRate}set automationRate(e){this.playbackRate.automationRate=e}get maxValue(){return this.playbackRate.maxValue}get minValue(){return this.playbackRate.minValue}get defaultValue(){return this.playbackRate.defaultValue}set value(e){let t=x(e,this.minValue,this.maxValue);this.rate=t,this.playbackRate.value=t}get value(){return this.rate}get detune(){return this._detune}set detune(e){this._detune=e,this.playbackRate.value=tt(this.rate)(e)}cancelAndHoldAtTime(e){return this.playbackRate.cancelAndHoldAtTime(e),this}cancelScheduledValues(e){return this.playbackRate.cancelScheduledValues(e),this}exponentialRampToValueAtTime(e,t){return this.playbackRate.exponentialRampToValueAtTime(e,t),this}linearRampToValueAtTime(e,t){return this.rate=e,this.playbackRate.linearRampToValueAtTime(e,t),this}setTargetAtTime(e,t,n){return this.rate=e,this.playbackRate.setTargetAtTime(e,t,n),this}setValueAtTime(e,t){return this.rate=e,this.playbackRate.setValueAtTime(e,t),this}setValueCurveAtTime(e,t,n){var i;return this.rate=(i=e[e.length-1])!==null&&i!==void 0?i:this.rate,this.playbackRate.setValueCurveAtTime(e,t,n),this}},Zt=class{constructor(e){Object.defineProperty(this,"playbackRate",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"automationRate",{enumerable:!0,configurable:!0,writable:!0,value:"k-rate"}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxValue",{enumerable:!0,configurable:!0,writable:!0,value:Ci}),Object.defineProperty(this,"minValue",{enumerable:!0,configurable:!0,writable:!0,value:ko}),Object.defineProperty(this,"detune",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.detune=0}cancelAndHoldAtTime(e){return this.playbackRate.cancelAndHoldAtTime(e),this}cancelScheduledValues(e){return this.playbackRate.cancelScheduledValues(e),this}exponentialRampToValueAtTime(e,t){return this.detune=e,this.playbackRate.exponentialRampToValueAtTime(tt(this.playbackRate.rate)(e),t),this}linearRampToValueAtTime(e,t){return this.detune=e,this.playbackRate.linearRampToValueAtTime(tt(this.playbackRate.rate)(e),t),this}setTargetAtTime(e,t,n){return this.playbackRate.setTargetAtTime(tt(this.playbackRate.rate)(e),t,n),this}setValueAtTime(e,t){return this.detune=e,this.playbackRate.setValueAtTime(tt(this.playbackRate.rate)(e),t),this}setValueCurveAtTime(e,t,n){var i;this.detune=(i=e[e.length-1])!==null&&i!==void 0?i:this.detune;let s=tt(this.playbackRate.rate);return this.playbackRate.setValueCurveAtTime(e.map(s),t,n),this}get value(){return this.detune}set value(e){let t=x(e,this.minValue,this.maxValue);this.detune=t,this.playbackRate.detune=t}};function Bo(r){return x(Math.pow(2,r/1200),0,Ci)}function tt(r){return e=>Bo(e)*r}function Ri(r){if(r.webkitAudioContext===void 0){d().log("[polyfill]: cannot install webkitAudioContext polyfill since webkitAudioContext does not exist on global.");return}function e(n){var i;n&&P(n,"setTargetAtTime",{value:(i=n.setTargetAtTime)!==null&&i!==void 0?i:n.setTargetValueAtTime})}let t=r.webkitAudioContext.prototype;if("polyfilled"in t&&t.polyfilled===!0){d().log("[polyfill]: webkitAudioContext polyfill has already been installed.");return}if(G(t,"createScriptProcessor")||P(t,"createScriptProcessor",{value:t.createJavaScriptNode,writable:!0}),G(t,"createPeriodicWave")||P(t,"createPeriodicWave",{value:t.createWaveTable,writable:!0}),G(t,"createGain")||P(t,"createGain",{value:function(){let n=this.createGainNode();return e(n.gain),n}}),G(t,"createDelay")||P(t,"createDelay",{value:function(n){let i=this.createDelayNode(n);return e(i.delayTime),i}}),P(t,"internal_createBufferSource",{value:t.createBufferSource,writable:!0}),t.createBufferSource=function(){var n,i;let s=this.internal_createBufferSource();return P(s,"start",{value:(n=s.start)!==null&&n!==void 0?n:function(o=0,a,u){a!==void 0||u!==void 0?this.noteGrainOn(o,a,u):this.noteOn(o)}}),P(s,"stop",{value:(i=s.stop)!==null&&i!==void 0?i:function(o=0){this.noteOff(o)}}),e(s.playbackRate),G(s,"detune")||(P(s,"playbackRate",{value:new Jt(s.playbackRate)}),P(s,"detune",{value:new Zt(s.playbackRate)})),e(s.detune),s},P(t,"internal_createDynamicsCompressor",{value:t.createDynamicsCompressor,writable:!0}),t.createDynamicsCompressor=function(){let n=this.internal_createDynamicsCompressor();return e(n.threshold),e(n.knee),e(n.ratio),e(n.attack),e(n.release),n},P(t,"internal_createBiquadFilter",{value:t.createBiquadFilter,writable:!0}),t.createBiquadFilter=function(){let n=this.internal_createBiquadFilter();return e(n.frequency),e(n.detune),e(n.Q),e(n.gain),n},G(t,"createOscillator")&&!G(t,"internal_createOscillator")&&(P(t,"internal_createOscillator",{value:t.createOscillator,writeable:!0}),t.createOscillator=function(){var n,i,s;let o=this.internal_createOscillator();return P(o,"start",{value:(n=o.start)!==null&&n!==void 0?n:o.noteOn}),P(o,"stop",{value:(i=o.stop)!==null&&i!==void 0?i:function(a=0){this.noteOff(a)}}),P(o,"setPeriodicWave",{value:(s=o.setPeriodicWave)!==null&&s!==void 0?s:o.setWaveTable,writable:!0}),e(o.frequency),e(o.detune),o}),P(t,"internal_decodeAudioData",{value:t.decodeAudioData,writable:!0}),P(t,"decodeAudioData",{value:async function(n,i,s){let o=(a,u)=>{this.internal_decodeAudioData(n,l=>{i!==void 0?i(l):a(l)},l=>{s!==void 0?s(l):u(l)})};return await new Promise(o)}}),P(t,"polyfilled",{value:!0}),r.AudioContext!==void 0){d().log("[polyfill]: cannot replace AudioContext with webkitAudioContext since AudioContext already exists on global.");return}P(r,"AudioContext",{value:r.webkitAudioContext})}function Li(r={},e=window){Kt();let t={AudioParam:"AudioParam"in e,AudioContext:"AudioContext"in e,OfflineAudioContext:"OfflineAudioContext"in e,webkitAudioContext:"webkitAudioContext"in e,webkitOfflineAudioContext:"webkitOfflineAudioContext"in e,createStereoPanner:"AudioContext"in e&&"createStereoPanner"in e.AudioContext.prototype||"webkitAudioContext"in e&&"createStereoPanner"in e.webkitAudioContext,Event:"Event"in e&&typeof e.Event=="function",EventTarget:"EventTarget"in e&&typeof e.EventTarget=="function"},n={AudioParam:r.AudioParam===!0||t.AudioParam,webkitAudioContext:r.webkitAudioContext===!0||t.webkitAudioContext&&!t.AudioContext,webkitOfflineAudioContext:r.webkitOfflineAudioContext===!0||t.webkitOfflineAudioContext&&!t.OfflineAudioContext,createStereoPanner:r.createStereoPanner===!0||!t.createStereoPanner,Event:r.Event===!0||!t.Event};d().debug("[polyfill] Parameters that exist on global:",t);let i=o=>{let[a]=xn(o)(e);return a!==null&&d().log(a),a===null},s={AudioParam:n.AudioParam===!0&&i(()=>{d().debug("[polyfill] installing AudioParam"),Ti(e)}),webkitAudioContext:n.webkitAudioContext===!0&&i(()=>{d().debug("[polyfill] installing webkitAudioContext"),Ri(e)}),webkitOfflineAudioContext:n.webkitOfflineAudioContext===!0&&i(()=>{d().debug("[polyfill] installing webkitOfflineAudioContext"),P(e,"OfflineAudioContext",{value:e.webkitOfflineAudioContext})}),createStereoPanner:n.createStereoPanner===!0&&i(()=>{d().debug("[polyfill] installing createStereoPanner"),Ni(e)}),Event:n.Event===!0&&i(()=>{d().debug("[polyfill] installing Event"),P(e,"Event",{value:Be})})};return Di(),s}var er="4.5.0";var Fo=()=>typeof navigator!="undefined",qo=r=>(r!=null?r:Fo())&&/chrome|firefox/i.test(navigator==null?void 0:navigator.userAgent.toLowerCase()),Uo=(r,e)=>{let t=`\u{1F3B5} ECAS: v${r} \u{1F3B5}`;if(e)return[`
%c${t}%c

`,"color: #FFFFFF; background: #ff7373; padding:10px","padding:0"];{let n=t.split("").map(()=>".").join("");return[`${n}
${t}
${n}`]}},Mi=r=>{r(...Uo(er,qo()))};var Fr,qr,tr=class extends globalThis.EventTarget{constructor(){super(...arguments),Object.defineProperty(this,"aborted",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"onabort",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"reason",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}throwIfAborted(){if(this.aborted)throw new Error("Aborted")}_abort(){var e;this.aborted=!0,(e=this.onabort)===null||e===void 0||e.call(this)}},Ur=class{constructor(){Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:new tr})}abort(){var e,t;(t=(e=this.signal)._abort)===null||t===void 0||t.call(e)}},Uf=(Fr=globalThis.AbortSignal)!==null&&Fr!==void 0?Fr:tr,Gr=(qr=globalThis.AbortController)!==null&&qr!==void 0?qr:Ur;function ki(r){var e,t,n,i,s,o,a,u,l,c,m,p,h,g,O,S,B,D;let N=q=>{var w,A;return(A=(w=r.soundManager)===null||w===void 0?void 0:w.requestBufferSync(q))!==null&&A!==void 0?A:null},_=async q=>{var w,A;return(A=await((w=r.soundManager)===null||w===void 0?void 0:w.requestBufferAsync(q)))!==null&&A!==void 0?A:null},Y=q=>{var w,A;return(A=(w=r.soundManager)===null||w===void 0?void 0:w.requestBufferReversedSync(q))!==null&&A!==void 0?A:null},Q=async q=>{var w,A;return(A=await((w=r.soundManager)===null||w===void 0?void 0:w.requestBufferReversedAsync(q)))!==null&&A!==void 0?A:null},F=q=>{var w,A,_e;return(_e=(A=(w=r.busHandler)===null||w===void 0?void 0:w.get(q))===null||A===void 0?void 0:A.input)!==null&&_e!==void 0?_e:null},R=q=>{var w,A;return(A=(w=r.stealers)===null||w===void 0?void 0:w.get(q))!==null&&A!==void 0?A:null},ce=q=>{var w,A;return(A=(w=r.syncers)===null||w===void 0?void 0:w.get(q))!==null&&A!==void 0?A:null},V=()=>null,pe=(n=(t=(e=r.nodePool)===null||e===void 0?void 0:e.requestFilterNode)===null||t===void 0?void 0:t.bind(r.nodePool))!==null&&n!==void 0?n:V,Ae=(o=(s=(i=r.nodePool)===null||i===void 0?void 0:i.requestGainNode)===null||s===void 0?void 0:s.bind(r.nodePool))!==null&&o!==void 0?o:V,E=(l=(u=(a=r.nodePool)===null||a===void 0?void 0:a.requestPanNode)===null||u===void 0?void 0:u.bind(r.nodePool))!==null&&l!==void 0?l:V,L=(p=(m=(c=r.nodePool)===null||c===void 0?void 0:c.returnGainNode)===null||m===void 0?void 0:m.bind(r.nodePool))!==null&&p!==void 0?p:V,ie=(O=(g=(h=r.nodePool)===null||h===void 0?void 0:h.returnPanNode)===null||g===void 0?void 0:g.bind(r.nodePool))!==null&&O!==void 0?O:V,me=(D=(B=(S=r.nodePool)===null||S===void 0?void 0:S.returnFilterNode)===null||B===void 0?void 0:B.bind(r.nodePool))!==null&&D!==void 0?D:V;return{requestFilterNode:pe,requestGainNode:Ae,requestPanNode:E,returnGainNode:L,returnFilterNode:me,returnPanNode:ie,requestBuffer:N,requestBufferAsync:_,requestBufferReversed:Y,requestBufferReversedAsync:Q,requestDestination:F,requestStealer:R,requestSyncer:ce}}function Bi(){return{buffers:new Map,promises:new Map}}async function Fi({buffers:r,promises:e},t){let n=r.get(t);if(n!==void 0)return n.slice(0);let i=e.get(t);i===void 0&&(i=fetch(t),e.set(t,i));let s=await i.catch(()=>{});if((s==null?void 0:s.ok)!==!0){de`[ecas] bad response for ${t}`,e.delete(t);return}return n=await s.arrayBuffer(),n===void 0&&de`[ecas] undefined arraybuffer for ${t}`,r.set(t,n),e.delete(t),n.slice(0)}var Go=4,Vo=2,rr=class r{constructor(e={},t=new Map,n=i=>{d().debug("disposing ",i)}){Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"history",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"disposeFile",{enumerable:!0,configurable:!0,writable:!0,value:n})}static create(e){return new r(e.options,e.history,e.disposeFile)}limit(e){let t=Vr(this.history)+e,n=qi(this.options.megabytes);if(!Xo(t,n))return!1;if(this.options.strategy==="block-new-requests")return M`[ecas] memory blocking new requests`,!0;if(t-n<0)return!1;M`[ecas] memory limit ${n} reached - freeing`;let s=0;do{let o=$o(this.history,this.options.strategy);if(o===void 0){de`[ecas] memory no items found to steal`;break}let a=o.megabytes;M`[ecas] memory dispose ${o.name}`,this.disposeFile(o.name),o.isActive=!1,t-=a}while(t>n&&s++<10);return!1}currentUsage(){return Vr(this.history)}add(e,t,n){let i=this.history.get(e),s=$r(t,n),o=Vr(this.history)+s;if(M`[ecas] memory add ${s.toPrecision(4)} - new usage: ${o.toPrecision(4)} - file: ${e}`,i===void 0){this.history.set(e,{megabytes:s,timesUsed:1,name:e,isActive:!0});return}this.history.set(e,{megabytes:i.megabytes,timesUsed:i.timesUsed+1,name:e,isActive:!0})}inactive(e){let t=this.history.get(e);t!==void 0&&(t.isActive=!1)}use(e,t=1){let n=this.history.get(e);if(n===void 0){this.history.set(e,{megabytes:0,timesUsed:t,name:e,isActive:!1});return}this.history.set(e,{megabytes:n.megabytes,timesUsed:n.timesUsed+t,name:e,isActive:!0})}setMemoryLimit(e){Object.assign(this.options,{megabytes:qi(e)})}setStrategy(e){Object.assign(this.options,{strategy:e})}dispose(){this.history.clear()}};function $o(r,e){switch(e){case"unload-oldest":return Ho(r);default:return Wo(r)}}function Ho(r){for(let e of r.values())if(e.isActive)return e}function Wo(r){let e,t=Number.MAX_SAFE_INTEGER;for(let n of r.values())n.isActive&&n.timesUsed<t&&(t=n.timesUsed,e=n);return e}function qi(r){return Math.max(r!=null?r:Number.MAX_SAFE_INTEGER,Vo)}function Xo(r,e){return r>e}function Vr(r){let e=0;for(let t of r.values())t.isActive&&(e+=t.megabytes);return e}function Yo(r){return r/1024**2}function $r(r,e){return Yo(r*e*Go)}var k=class r{static new(){return new r}static from(e){let t=r.new();return e===null?t.resolve(null):t.resolve(e),t}constructor(){Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"SoundPromise"}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"internal",{enumerable:!0,configurable:!0,writable:!0,value:Qe()}),Object.defineProperty(this,"resolve",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reject",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.unresolve()}unresolve(){this.state=r.State.UNLOADED,this.value=null,this.internal.resolve(null),this.internal=Qe(),this.resolve=e=>{this.state=e===null?r.State.REJECTED:r.State.LOADED,this.value=e,this.internal.resolve(e)},this.reject=e=>{this.state=r.State.REJECTED,this.value=null,this.internal.reject(e)}}async then(e,t){return this.state===r.State.DISPOSED?null:await this.internal.promise.then(e,t)}async catch(e){return this.state===r.State.DISPOSED?null:await this.internal.promise.catch(e)}async finally(e){return this.state===r.State.DISPOSED?null:await this.internal.promise.finally(e)}dispose(){return this.state!==r.State.DISPOSED&&(this.unresolve(),this.state=r.State.DISPOSED),this}};Object.defineProperty(k,"StateNames",{enumerable:!0,configurable:!0,writable:!0,value:["UNLOADED","LOADING","LOADED","REJECTED","DISPOSED"]});Object.defineProperty(k,"State",{enumerable:!0,configurable:!0,writable:!0,value:{UNLOADED:0,LOADING:1,LOADED:2,REJECTED:3,DISPOSED:4,toString(r){return k.StateNames[r]}}});var Ui="_",T=0,Ee=1,Hr=0,X=1,Se=2,rt=3,Gi;(function(r){r[r.RUNNING=0]="RUNNING",r[r.DISPOSED=1]="DISPOSED"})(Gi||(Gi={}));var ut=class extends De{constructor(e,t={},n={megabytes:Number.MAX_VALUE,strategy:"unload-oldest"},i="./encoded/",s=Object.keys(t),o=["english",Ui],a=".webm",u=[],l=new Map,c=new Map,m=T,p=new rr(n,new Map,S=>{this.disposeFile(S)}),h=!1,g=!1,O=Bi()){super(),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"atlas",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"memory",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"sourcePath",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"activePackageNames",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"activeLanguages",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"fileExtension",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"priorities",{enumerable:!0,configurable:!0,writable:!0,value:u}),Object.defineProperty(this,"forward",{enumerable:!0,configurable:!0,writable:!0,value:l}),Object.defineProperty(this,"reversed",{enumerable:!0,configurable:!0,writable:!0,value:c}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:m}),Object.defineProperty(this,"limiter",{enumerable:!0,configurable:!0,writable:!0,value:p}),Object.defineProperty(this,"mono",{enumerable:!0,configurable:!0,writable:!0,value:h}),Object.defineProperty(this,"use16Bit",{enumerable:!0,configurable:!0,writable:!0,value:g}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:O}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"SoundManager"})}async loadAtlas(e=`${this.sourcePath}.atlas.json`){if(this.state!==T)return;let n=await(await fetch(e)).json();this.atlas=n,this.dispatchEvent({type:"atlasloaded",detail:{}})}setAtlas(e){this.state===T&&(this.atlas=e,this.dispatchEvent({type:"atlasloaded",detail:{}}))}setLanguage(e){return this.state!==T||this.activeLanguages[0]===e||!this.getLanguages().includes(e)?!1:(this.activeLanguages.splice(0,this.activeLanguages.length),this.activeLanguages.push(e,Ui),this.dispatchEvent({type:"languagechanged",detail:e}),!0)}setPackageByName(e){if(this.state!==T||e===this.activePackageNames[0]||this.atlas[e]===void 0)return!1;let n=this.activePackageNames.indexOf(e);return n===-1?!1:(this.activePackageNames.splice(n,1),this.activePackageNames.unshift(e),this.dispatchEvent({type:"packagechanged",detail:e}),!0)}getPackageItems(e){var t,n;return e===void 0&&(e=(t=this.activePackageNames[0])!==null&&t!==void 0?t:""),this.state===Ee?[]:(n=this.atlas[e])!==null&&n!==void 0?n:[]}getPackages(e){return this.state===Ee?[]:e===void 0?Object.values(this.atlas):e.filter(t=>fr(this.atlas[t])).map(t=>this.getPackageItems(t))}getPackageNames(e){return this.state===Ee?[]:e!=null?e.filter(t=>t in this.atlas):Object.keys(this.atlas)}getSourceNames(e=this.getPackageNames(),t=this.getLanguages()){if(this.state!==T)return[];let n=[];for(let i of this.getPackages(e))for(let s of i)t.includes(s[rt])&&n.push(s[Hr]);return Wr(n)}getActiveSourceNames(){return this.getSourceNames(this.activePackageNames,this.activeLanguages)}getSourceUrl(e){if(this.state!==T)return;let t=this.findItemBySourceName(e);if(t!==void 0)return`${this.sourcePath}${t[X]}${this.fileExtension}`}getSourceNumSamples(e){if(this.state!==T)return;let t=this.findItemBySourceName(e);return t!=null?t[Se]:void 0}getSourceNumChannels(e){if(this.state!==T)return;let t=this.findItemBySourceName(e);if(t!==void 0)return at(t[X])}getSourceDuration(e){if(this.state!==T)return;let t=this.findItemBySourceName(e);if(t!==void 0)return t[Se]/this.context.sampleRate}getLanguages(e=this.getPackageNames()){if(this.state!==T)return[];let t=[];for(let n of this.getPackages(e))for(let i of n){let s=i[rt];t.includes(s)||t.push(s)}return t}getAllFilenames(){return Wr(Object.values(this.atlas).flat().map(e=>e[X]))}getAllUrls(){return Wr(this.getAllFilenames().map(e=>this.getUrlByFile(e)))}getAllDetails(){return this.getAllFilenames().map(e=>this.getDetailsByFile(e))}getAllItems(){return Object.values(this.atlas).flat()}setLoadPath(e){this.state===T&&(this.sourcePath=e.endsWith("/")?e:`${e}/`,this.dispatchEvent({type:"loadpathchanged",detail:e}))}setPriorityList(e){this.priorities=[...e]}requestBufferAsync(e){let t=this.findItemBySourceName(e);return t===void 0?k.from(null):this.loadItem(t)}requestBufferReversedAsync(e){let t=this.findItemBySourceName(e);if(t===void 0)return k.from(null);let n=t[X];if(this.reversed.has(n))return this.limiter.use(n),this.reversed.get(n);let i=this.loadItem(t);if(i.value===null)return this.reversed.set(n,i),i;let s=this.context.createBuffer(i.value.numberOfChannels,i.value.length,this.context.sampleRate),o=k.new();return this.reversed.set(n,o),o.value=s,i.then(a=>a===null?null:($i(s,a),Ko(s),o.resolve(s),s)),o}requestBufferSync(e){return this.requestBufferAsync(e).value}requestBufferReversedSync(e){return this.requestBufferReversedAsync(e).value}getUrlByItem(e){return this.getUrlByFile(e[X])}getFileByItem(e){return e[X]}getFileBySource(e){let t=this.findItemBySourceName(e);return t!=null?t[X]:void 0}getNumSamplesByItem(e){return e[Se]}getNumChannelsByItem(e){return at(e[X])}getDurationByItem(e){return e[Se]/this.context.sampleRate}getNumSamplesByFile(e){let t=this.findItemByFileName(e);return t!=null?t[Se]:void 0}getDurationByFile(e){let t=this.findItemByFileName(e);return t!=null?t[Se]/this.context.sampleRate:void 0}getLoadStateByFile(e){var t,n;return(n=(t=this.forward.get(e))===null||t===void 0?void 0:t.state)!==null&&n!==void 0?n:k.State.UNLOADED}getUrlByFile(e){return`${this.sourcePath}${e}${this.fileExtension}`}getDetailsByFile(e){let t=this.findItemByFileName(e);if(t!==void 0)return{state:this.getLoadStateByFile(e),url:this.getUrlByFile(e),duration:this.getDurationByItem(t),numSamples:this.getNumSamplesByItem(t),numChannels:at(e),sourceName:t[Hr],fileName:t[X],bitrate:Vi(e)}}getNumSamplesBySource(e){let t=this.findItemBySourceName(e);return t!=null?t[Se]:void 0}getNumChannelsBySource(e){let t=this.findItemBySourceName(e);return t!=null?at(t[X]):void 0}getDurationBySource(e){let t=this.findItemBySourceName(e);return t!=null?t[Se]/this.context.sampleRate:void 0}getLoadStateBySource(e){let t=this.getFileNameBySourceName(e);if(t!==void 0)return this.getLoadStateByFile(t)}getDetailsBySource(e){let t=this.getFileNameBySourceName(e);if(t!==void 0)return this.getDetailsByFile(t)}getBitrateBySource(e){let t=this.getFileNameBySourceName(e);if(t!==void 0)return Vi(t)}getUrlBySource(e){let t=this.getFileNameBySourceName(e);if(t!==void 0)return this.getUrlByFile(t)}findItemBySourceName(e,t=this.activePackageNames,n=this.activeLanguages){if(this.state===T)for(let i of t){let s=this.getPackageItems(i),o=n[0],a=new Map;for(let u of s)if(u[Hr]===e){if(u[rt]===o)return u;a.set(u[rt],u)}if(a.size>0)for(let u of n.slice(1)){let l=a.get(u);if(l!==void 0)return l}}}findItemByFileName(e,t=this.activePackageNames){if(this.state===T)return t.flatMap(n=>this.getPackageItems(n)).find(n=>n[X]===e)}getFileNameBySourceName(e,t=this.activePackageNames,n=this.activeLanguages){if(this.state!==T)return;let i=this.findItemBySourceName(e,t,n);return i!=null?i[X]:void 0}loadItem(e){if(this.state!==T)return k.from(null);let t=e[X],n=this.getUrlByFile(t);if(this.forward.has(t))return this.limiter.use(t),this.forward.get(t);let[i,s]=Qo(this.context.sampleRate,this.mono,e),o=$r(s,i);if(this.limiter.limit(o))return de`[ecas] memory limit reached: blocking new sound requests`,k.from(null);let a=this.context.createBuffer(i,s,this.context.sampleRate);this.limiter.add(t,a.length,a.numberOfChannels);let u=k.new();return u.value=a,u.state=k.State.LOADING,this.forward.set(t,u),Fi(this.cache,n).then(async l=>l===void 0?(u.resolve(null),a):await this.context.decodeAudioData(l)).then(l=>{$i(a,l),u.resolve(a),this.dispatchEvent({type:"fileloaded",detail:t})}).catch(()=>{M`[ecas] failed to load sound file: ${t}`,u.resolve(null),this.dispatchEvent({type:"fileloaderror",detail:t})}),this.dispatchEvent({type:"fileloading",detail:t}),u}async loadItems(e){if(this.state!==T)return[];let t=this.priorities.length>0?zo([...e],this.priorities):e;return await Promise.all(t.map(n=>this.loadItem(n)))}loadFile(e){if(this.state!==T)return k.from(null);let t=this.forward.get(e);if(t!==void 0)return t;let n=this.findItemByFileName(e);return n===void 0?(this.dispatchEvent({type:"fileloaderror",detail:e}),k.from(null)):this.loadItem(n)}async loadPackageName(e=this.activePackageNames[0]){return this.state!==T?[]:await this.loadItems(this.getPackageItems(e))}async loadPackageNames(e){return this.state!==T?[]:await Promise.all(this.getPackageNames(e).map(async t=>await this.loadPackageName(t))).then(t=>t.flat())}async loadEverything(){return this.state!==T?[]:await this.loadPackageNames(this.getPackageNames())}async loadLanguage(e=this.activeLanguages[0],t=this.activePackageNames){this.state===T&&await Promise.all(this.getPackages(t).map(n=>n.filter(i=>i[rt]===e).flatMap(i=>this.loadItem(i))))}async loadLanguages(e=this.activeLanguages,t=this.activePackageNames){this.state===T&&await Promise.all(e.map(async n=>{await this.loadLanguage(n,t)}))}async loadSource(e){if(this.state!==T)return null;let t=this.findItemBySourceName(e);return t===void 0?null:await this.loadItem(t)}async loadSources(e){if(this.state!==T)return[];let t=e.map(n=>this.findItemBySourceName(n));return await this.loadItems(t.filter(fr))}async loadPriorityList(){return await this.loadSources(this.priorities)}disposeSource(e){let t=this.findItemBySourceName(e);t!==void 0&&this.disposeItem(t)}disposeFile(e){var t,n;this.state!==Ee&&((t=this.forward.get(e))===null||t===void 0||t.dispose(),this.forward.delete(e),(n=this.reversed.get(e))===null||n===void 0||n.dispose(),this.reversed.delete(e),this.limiter.inactive(e))}disposeItem(e){this.disposeFile(e[X])}disposePackage(e=this.activePackageNames[0]){if(this.state!==Ee)for(let t of this.getPackageItems(e))this.disposeItem(t)}disposePackages(e=this.getPackageNames()){if(this.state!==Ee)for(let t of this.getPackages(e))for(let n of t)this.disposeItem(n)}disposeLanguage(e=this.activeLanguages[0],t=this.getPackageNames()){if(this.state!==Ee)for(let n of this.getPackages(t))for(let i of n)i[rt]===e&&this.disposeItem(i)}dispose(e=!0){this.state!==Ee&&(e&&super.dispose(),this.disposePackages(),this.forward.clear(),this.reversed.clear(),this.cache.buffers.clear(),this.cache.promises.clear(),this.state=Ee)}reload(e=!1){return this.dispose(e),this.state=T,this.dispatchEvent({type:"reloaded",detail:{}}),this}reloadWithAtlas(e=this.atlas,t=!1){return this.reload(t),this.setAtlas(e),this}};function Qo(r,e,t){let n=r!==48e3,i=r/48e3,s=at(t[X]),o=t[Se],a=e?1:s,u=Math.floor(n?o*i:o);return[a,u]}function at(r){let t=r.split(".")[1];if(t===void 0)return;let n=t.replace("ch","");try{return Number(n)}catch(i){return}}function Vi(r){let t=r.split(".")[0];if(t===void 0)return;let n=t.replace("kb","");try{return Number(n)}catch(i){return}}function Hi(r){return new ut(r.context,r.atlas,r.memory,r.sourcePath,r.activePackageNames,r.activeLanguages,r.fileExtension,r.priorities,r.forward,r.reversed,r.state,r.limiter,r.mono,r.use16bit,r.cache)}function $i(r,e){let t=Math.min(r.numberOfChannels,e.numberOfChannels);try{if(r.numberOfChannels===1&&e.numberOfChannels===2){let n=r.getChannelData(0),i=e.getChannelData(0),s=e.getChannelData(1),o=Math.min(r.length,e.length);for(let a=0;a<o;a++)n[a]=(i[a]+s[a])/2}else for(let n=0;n<t;n++)e.copyFromChannel(r.getChannelData(n),n)}catch(n){let i=Math.min(r.length,e.length);for(let s=0;s<t;s++){let o=r.getChannelData(s),a=e.getChannelData(s);o.set(a.subarray(0,i),0)}}}function Ko(r){let e=r.numberOfChannels;for(let t=0;t<e;t++)r.getChannelData(t).reverse()}function zo(r,e){let t=new Map(e.map((i,s)=>[i,s])),n=e.length;return r.sort((i,s)=>{var o,a;let u=(o=t.get(i[0]))!==null&&o!==void 0?o:n,l=(a=t.get(s[0]))!==null&&a!==void 0?a:n;return u-l})}function Wr(r){let e={};for(let t of r)e[t]=!0;return Object.keys(e)}var Jo="enter",Zo="cancel",ea="timeout",nr=class r{constructor(e,t,n,i,s){Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"procedures",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"scheduler",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"target",{enumerable:!0,configurable:!0,writable:!0,value:s})}static from(e){var t;let i={current:nt(e.config)[0],timeout:-1,disposed:!1},s=(t=e.context)!==null&&t!==void 0?t:new AudioContext({sampleRate:48e3,latencyHint:"playback"}),o=new Ze(s),a=new De;return new r(e.config,i,e.procedures,o,a)}play(e){var t;let n=(t=e==null?void 0:e.targetStage)!==null&&t!==void 0?t:this.state.current;if(this.state.disposed)return f(void 0);if(this.scheduler.cancel(this.state.timeout),M`[ecas] stage play ${n}`,this.procedures===void 0){let l=`[ecas] Stage -> Undefined Procedures For ${n}`;return de`${l}`,v(new Error(l))}let s=this.config[n];if(s===void 0){let l=`[ecas] Stage -> undefined current for ${n}`;return de`${l}`,v(new Error(l))}this.target.dispatchEvent({type:Jo,detail:{stage:n,next:s.next}});let o=s.next;o!==void 0&&(this.state.current=o);let a=s.onTimeout;if(a!==void 0&&s.timeout!==void 0){let l=this.scheduler.context.currentTime+s.timeout,c=()=>{M`[ecas] stage timeout for ${n}`,this.target.dispatch(ea,{stage:"name",next:a}),this.state.current=a,this.play()},m=this.scheduler.schedule(c,l);this.state.timeout=m}let u=s.onEnter;return u!==void 0&&this.procedures.triggerOnPropertyEventOrAction(u),f(void 0)}cancel(e){return this.scheduler.cancel(this.state.timeout),this.target.dispatchEvent({type:Zo,detail:{stage:this.state.current,next:void 0}}),f(void 0)}dispose(){this.scheduler.cancel(),this.state.disposed=!0}};var lt={DISABLED:0,ENABLED:1};function Wi(r,e=1){let{debug:t}=d(),n=lt.DISABLED,i;function s(){r.state==="running"?r.suspend().catch(()=>{t("[ecas] failed to suspend the audio context")}):t(`[ecas] audio context tried to pause while in ${r.state}`)}function o(){r.resume().then(()=>{t("[ecas] sucessfully resumed the suspended context"),window.removeEventListener("click",a,{capture:!0})}).catch(()=>{t("[ecas] failed to resume the suspended context"),window.addEventListener("click",a,{capture:!0,passive:!0})})}function a(){let h=r.state;t("[ecas] resume context",h),h==="suspended"?o():h==="interrupted"?window.addEventListener("click",o,{once:!0,capture:!0,passive:!0}):h==="running"&&(t("[ecas] context is already running"),window.removeEventListener("click",a,{capture:!0}))}function u(){t("[ecas] state change:",r.state)}function l(){i!==void 0&&(clearTimeout(i),i=void 0)}function c(){t(`[ecas] visibility change ${document.hidden?"hidden":"visible"} state: ${r.state}`);let h=r.state;document.hidden?h==="running"&&(e<=0?s():i===void 0&&(i=window.setTimeout(()=>{s(),i=void 0},e*1e3))):(h==="suspended"||h==="interrupted")&&(l(),a())}function m(){n===lt.DISABLED&&(document.addEventListener("visibilitychange",c,{capture:!0,passive:!0}),r.addEventListener("statechange",u,{capture:!0,passive:!0}),n=lt.ENABLED)}function p(){n===lt.ENABLED&&(document.removeEventListener("visibilitychange",c,{capture:!0}),r.removeEventListener("statechange",u,{capture:!0}),l(),n=lt.DISABLED)}return{enable:m,disable:p}}var b;(function(r){r[r.RUNNING=0]="RUNNING",r[r.DISPOSED=1]="DISPOSED",r[r.PAUSED=2]="PAUSED"})(b||(b={}));var y=v(new Error("[ecas] already disposed")),ir=qe(new Error("[ecas] already disposed"));function Xi(r,e){if(e.event==="*"){for(let n of r.values())for(let i of n)window.clearTimeout(i.timeoutId);r.clear();return}let t=r.get(e.event);if(t!==void 0)for(let n of t)(n.options.event===e.event||e.event==="*")&&window.clearTimeout(n.timeoutId),t.length=0}function ta(r){M`[ecas] cancel procedure call for ${r.name}`;let{map:e,name:t}=r;if(t==="*"){for(let i of e.values())for(let s of i)window.clearTimeout(s.timeoutId);return e.clear(),f(void 0)}let n=e.get(t);if(n===void 0)return f(void 0);for(let i of n)window.clearTimeout(i.timeoutId);return n.length=0,f(void 0)}function Yi(r){var e;let t=Xr(Object.assign(Object.assign({},r.sync),{assetRequester:r.ecas.assetRequester}));if(M`[ecas] schedule procedure call for ${r.name} in ${t/1e3} s`,t===0)return r.callback();let n=()=>{if(r.ecas.state===b.DISPOSED)return y;r.callback();let o=r.map.get(r.name);if(o===void 0)return f(void 0);let a=o.findIndex(u=>u.timeoutId===i);return a===-1?f(void 0):(o.splice(a,1),f(void 0))},i=window.setTimeout(n,t),s=(e=r.map.get(r.name))!==null&&e!==void 0?e:[];return s.push({timeoutId:i,options:r,name:r.name}),r.map.set(r.name,s),f(void 0)}var ct=class r{constructor(e,t=new AudioContext,n){var i,s,o,a,u,l,c,m;Object.defineProperty(this,"audioContext",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"version",{enumerable:!0,configurable:!0,writable:!0,value:er}),Object.defineProperty(this,"scheduledGameEvents",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"scheduledAudioEvents",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"scheduledStages",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"eventHandler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"soundManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"assetRequester",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"busHandler",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"isMuted",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:b.RUNNING}),Object.defineProperty(this,"syncers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stealers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"buffers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"containers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"player",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"visibility",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"muteOnInvisible",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"nodePool",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onstatechange",{enumerable:!0,configurable:!0,writable:!0,value:()=>{let E=this.audioContext.state;switch(E){case"running":this.eventHandler.triggerAudioEvent(he.Context.Running);break;case"closed":this.eventHandler.triggerAudioEvent(he.Context.Closed);break;case"suspended":this.eventHandler.triggerAudioEvent(he.Context.Suspended);break;case"interrupted":this.eventHandler.triggerAudioEvent(he.Context.Interrupted);break;default:d().error("[ecas] AudioContext statechange event triggered with unknown state:",E);break}}}),Object.defineProperty(this,"onsoundstarted",{enumerable:!0,configurable:!0,writable:!0,value:({detail:E})=>{this.eventHandler.triggerAudioEvent(he.Sound.PlaybackStart,E.name)}}),Object.defineProperty(this,"onsoundended",{enumerable:!0,configurable:!0,writable:!0,value:({detail:E})=>{this.eventHandler.triggerAudioEvent(he.Sound.PlaybackEnd,E.name)}}),Object.defineProperty(this,"pauseTimeoutId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"unpauseTimeoutId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setStateTimeoutId",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{log:p,debug:h,info:g}=d();Mi(p),this.options=_r(e);let{soundConfig:O,eventConfig:S,stateConfig:B,loadrConfig:D}=this.options,{buses:N}=O,{loadPath:_,fileExtToUse:Y,preload:Q,memoryLimit:F,initialMasterVolume:R,defaultFadeInCurve:ce=Le,defaultFadeOutCurve:V=Le}=D;h("[ecas] config:",e),h("[ecas] options:",this.options),g("[ecas] file extension:",Y),this.eventHandler=new Qt(S,B,D.initState,this),this.audioContext.addEventListener("statechange",this.onstatechange),this.soundManager=n!=null?n:new ut(this.audioContext,this.options.atlas,F),n===void 0&&(this.soundManager.fileExtension=Y!=null?Y:".webm",this.soundManager.setLoadPath(`${(i=_==null?void 0:_.split("/").slice(0,-2).join("/"))!==null&&i!==void 0?i:"unknown"}/`),this.soundManager.setPackageByName("base"),this.soundManager.setLanguage("en"),Array.isArray(Q)?(this.soundManager.setPriorityList(Q),this.soundManager.loadPriorityList()):Q===!0&&this.soundManager.loadEverything()),this.nodePool=ze.FromContext(t,this.options.loadrConfig),this.syncers=new Map(Xe((s=O.syncers)!==null&&s!==void 0?s:{}).map(([E,L])=>[E,new $t(this.audioContext,L)])),this.stealers=new Map(Xe((o=O.stealers)!==null&&o!==void 0?o:{}).map(([E,L])=>[E,new Ft(this.audioContext,Object.assign({name:E},L))]));let pe={nodePool:this.nodePool,soundManager:this.soundManager,stealers:this.stealers,syncers:this.syncers};this.assetRequester=ki(pe),this.busHandler=new Dt(this.audioContext,this.assetRequester,N!=null?N:[]),pe.busHandler=this.busHandler,this.busSetGain({busId:$,gain:R!=null?R:1}),this.muteOnInvisible={isEnabled:!1,abortController:new Gr},this.shouldMuteOnInvisible=(a=D==null?void 0:D.muteOnInvisible)!==null&&a!==void 0?a:!0,this.visibility=Wi(this.audioContext),(!((u=D.pauseOnInvisible)!==null&&u!==void 0)||u)&&this.visibility.enable(),this.player=new Vt({assetRequester:this.assetRequester,context:this.audioContext,triggerOnPropertyCallback:this.eventHandler.triggerOnPropertyEventOrAction.bind(this.eventHandler),defaultFadeInCurve:ce,defaultFadeOutCurve:V}),this.buffers=new Map(Xe((l=O.buffers)!==null&&l!==void 0?l:{}).map(([E,L])=>{var ie;return[E,Object.assign(Object.assign({name:E},L),{sourceName:(ie=L.sourceName)!==null&&ie!==void 0?ie:E})]})),this.containers=new Map(Xe((c=O.containers)!==null&&c!==void 0?c:{}).map(([E,L])=>{var ie,me;let q=Object.assign(Object.assign({name:E},L),{voices:(me=(ie=L.voices)===null||ie===void 0?void 0:ie.map(w=>(w==null?void 0:w.name)===void 0?w:Object.assign(Object.assign({},this.buffers.get(w.name)),w)))!==null&&me!==void 0?me:[]});return[E,new Gt({player:this.player,properties:q})]}));let Ae=Xe((m=O.stages)!==null&&m!==void 0?m:{}).map(([E,L])=>{let ie=this.eventHandler,me=nr.from({config:L,procedures:ie,context:this.audioContext});return[E,me]});this.stages=new Map(Ae),h("[ecas] syncers:",this.syncers.keys()),h("[ecas] stealers:",this.stealers.keys()),h("[ecas] buffers:",this.buffers.keys()),h("[ecas] containers:",this.containers.keys()),this.player.target.addEventListener("started",this.onsoundstarted),this.player.target.addEventListener("ended",this.onsoundended)}set shouldMuteOnInvisible(e){if(this.state===b.DISPOSED)return;let{isEnabled:t,abortController:n}=this.muteOnInvisible;if(e&&t||!e&&!t)return;if(!e&&t){this.muteOnInvisible.isEnabled=!1,n.abort();return}let i=!this.isMuted,s=()=>{document.hidden?(i=!this.isMuted,this.mute()):i&&this.unmute()};this.muteOnInvisible.isEnabled=!0,n.signal.aborted&&(this.muteOnInvisible.abortController=new Gr),window.addEventListener("visibilitychange",s,{capture:!0,passive:!0,signal:this.muteOnInvisible.abortController.signal})}static async create(e={},t,n){var i,s,o,a,u,l,c,m,p,h,g;n!==void 0?En(n.url,n):jn()?Sn():gt((s=(i=e.loadrConfig)===null||i===void 0?void 0:i.logger)!==null&&s!==void 0?s:"none");let{debug:O}=d();Kt();let S=_r(e);O("[ecas] create",S);let{loadrConfig:B,atlas:D}=S,{loadPath:N,preload:_,forcePolyfills:Y,memoryLimit:Q,sampleRate:F,latencyHint:R}=B,ce=Li(Y);O("[ecas] polyfills installed",ce);let V={sampleRate:F!=null?F:48e3,latencyHint:R!=null?R:"playback"},pe=Array.isArray(_)&&_.length>0||_===!0;pe?t!=null||(t=new AudioContext(V)):t=await Mr(t,V);let Ae=(a=(o=e.loadrConfig)===null||o===void 0?void 0:o.fileExtToUse)!==null&&a!==void 0?a:await yi(t)?".webm":".mp4";S=Hn(S,Ae);let E=Hi({context:t,atlas:D,memory:Q,fileExtension:Ae,sourcePath:`${(u=N==null?void 0:N.split("/").slice(0,-2).join("/"))!==null&&u!==void 0?u:""}/`,mono:(l=B.mono)!==null&&l!==void 0?l:!1});E.setPackageByName((m=(c=e.loadrConfig)===null||c===void 0?void 0:c.initialPackageName)!==null&&m!==void 0?m:"base"),E.setLanguage((h=(p=e.loadrConfig)===null||p===void 0?void 0:p.initialLanguage)!==null&&h!==void 0?h:"en"),Array.isArray(_)?(E.setPriorityList(_),E.loadPriorityList()):_===!0&&E.loadEverything(),G(window,"soundManager")||P(window,"soundManager",{value:E}),pe&&(t=await Mr(t,V)),O("[ecas] creating ecas instance");let L=new r(S,t,E);return((g=e.loadrConfig)===null||g===void 0?void 0:g.stream)!==void 0&&await L.capture(e.loadrConfig.stream),L.eventHandler.triggerAudioEvent(he.Ready),L}async capture(e){if(e===void 0)return;let t=this.busHandler.buses.get(e);if(t===void 0){gr`[ecas] Stream -> No Bus Found For: ${e}`;return}let n=await new Promise(s=>{let o=performance.now(),a=setInterval(()=>{let u=document.querySelector("video");u===null?performance.now()-o>4e3&&s(void 0):(clearInterval(a),s(u))},100)});if(n===void 0){gr`[ecas] Stream -> Failed To Locate Video Element`;return}Tn`[ecas] Stream Enabled ${e}`,this.audioContext.createMediaElementSource(n).connect(t.input)}setLogger(e){return this.state===b.DISPOSED?y:(gt(e),f(void 0))}getLogger(){return d()}setCustomLogger(e){return this.state===b.DISPOSED?y:(Pn(e),f(void 0))}setMasterVolume(e){if(this.state===b.DISPOSED)return y;let{debug:t}=d(),n=typeof e=="number"?e:typeof e=="string"?Number(e):e.volume;return t("[ecas] setMasterVolume",n),this.isMuted?I("[ecas] tried to set gain while muted."):this.busSetGain({busId:$,gain:n})}getMasterVolume(){var e;if(this.state===b.DISPOSED)return y;let t=(e=this.busHandler.get($))===null||e===void 0?void 0:e.nodes.gain.gain.value;return t===void 0?I("[ecas] master bus gain is undefined"):f(t)}muteUnmute(e){return this.state===b.DISPOSED?y:this.isMuted?this.unmute():this.mute()}unmute(e){return this.state===b.DISPOSED?y:this.isMuted?(d().debug("[ecas] unmute"),this.isMuted=!1,this.eventHandler.triggerAudioEvent(he.Unmute),this.busApplyEnvelope({busId:oe,paramId:"gain",points:[{pos:0,val:"current"},{pos:500,val:1}]})):f(void 0)}mute(e){if(this.state===b.DISPOSED)return y;let{debug:t}=d();return t("[ecas] mute"),this.isMuted?(t("[ecas] already muted"),f(void 0)):this.audioContext.state!=="running"?(t("[ecas] audio context is not running, cannot mute"),f(void 0)):(this.isMuted=!0,this.eventHandler.triggerAudioEvent(he.Mute),this.busApplyEnvelope({busId:oe,paramId:"gain",points:[{pos:0,val:"current"},{pos:500,val:0}]}))}updateMuteBehaviour(e){return this.state===b.DISPOSED?y:(e.muteOnInvisible!==void 0&&this.shouldMuteOnInvisible!==e.muteOnInvisible&&(d().debug("[ecas] muteOnInvisible",e.muteOnInvisible),this.shouldMuteOnInvisible=e.muteOnInvisible),e.pauseOnInvisible!==void 0&&(d().debug("[ecas] pauseOnInvisible",e.pauseOnInvisible),e.pauseOnInvisible?this.visibility.enable():this.visibility.disable()),f(void 0))}pause(e={}){if(this.state===b.DISPOSED)return y;window.clearTimeout(this.pauseTimeoutId),window.clearTimeout(this.unpauseTimeoutId);let{initialDelay:t=0,context:n=!1,mute:i=!1,events:s=!0}=e,o=()=>{this.state!==b.DISPOSED&&(this.state=b.PAUSED,i&&this.mute(),s&&(this.eventHandler.state="paused"),n&&this.audioContext.suspend().catch(()=>{}))};return t>0?this.pauseTimeoutId=window.setTimeout(o,t*1e3):o(),f(void 0)}unpause(e={}){if(this.state===b.DISPOSED)return y;window.clearTimeout(this.pauseTimeoutId),window.clearTimeout(this.unpauseTimeoutId);let{initialDelay:t=0,context:n=!1,mute:i=!1,events:s=!0}=e,o=()=>{this.state!==b.DISPOSED&&(this.state=b.RUNNING,s&&(this.eventHandler.state="running"),n&&this.audioContext.resume().catch(()=>{}),i&&this.unmute())};return t>0?this.unpauseTimeoutId=window.setTimeout(o,t*1e3):o(),f(void 0)}triggerAudioEvent(e){var t;if(this.state===b.DISPOSED)return y;let n=Xr(Object.assign(Object.assign({},e),{assetRequester:this.assetRequester}));if(n===0)return e.args===void 0?this.eventHandler.triggerAudioEvent(e.event):this.eventHandler.triggerAudioEvent(e.event,...e.args),f(void 0);let i=()=>{if(this.state===b.DISPOSED)return y;e.args===void 0?this.eventHandler.triggerAudioEvent(e.event):this.eventHandler.triggerAudioEvent(e.event,...e.args);let a=this.scheduledAudioEvents.get(e.event);if(a===void 0)return f(void 0);let u=a.findIndex(l=>l.timeoutId===s);return u===-1?f(void 0):(a.splice(u,1),f(void 0))},s=window.setTimeout(i,n),o=(t=this.scheduledAudioEvents.get(e.event))!==null&&t!==void 0?t:[];return o.push({timeoutId:s,options:e,name:e.event}),this.scheduledAudioEvents.set(e.event,o),f(void 0)}triggerGameEvent(e,...t){var n;if(this.state===b.DISPOSED)return y;if(e===void 0)return v(new Error("[ecas] triggerGameEvent was triggered with undefined event"));let i=typeof e=="string"?{event:e,args:t}:e,s=Xr(Object.assign(Object.assign({},i),{assetRequester:this.assetRequester}));if(s===0)return i.args===void 0?this.eventHandler.triggerGameEvent(i.event):this.eventHandler.triggerGameEvent(i.event,...i.args),f(void 0);let o=()=>{if(this.state===b.DISPOSED)return y;i.args===void 0?this.eventHandler.triggerGameEvent(i.event):this.eventHandler.triggerGameEvent(i.event,...i.args);let l=this.scheduledGameEvents.get(i.event);if(l===void 0)return f(void 0);let c=l.findIndex(m=>m.timeoutId===a);return c===-1?f(void 0):(l.splice(c,1),f(void 0))},a=window.setTimeout(o,s),u=(n=this.scheduledGameEvents.get(i.event))!==null&&n!==void 0?n:[];return u.push({timeoutId:a,options:i,name:i.event}),this.scheduledGameEvents.set(i.event,u),f(void 0)}cancelGameEvent(e){return this.state===b.DISPOSED?y:(Xi(this.scheduledGameEvents,e),f(void 0))}cancelAudioEvent(e){return this.state===b.DISPOSED?y:(Xi(this.scheduledAudioEvents,e),f(void 0))}cancelEvent(e){return this.state===b.DISPOSED?y:(this.cancelGameEvent(e),this.cancelAudioEvent(e),f(void 0))}setState(e){if(this.state===b.DISPOSED)return y;window.clearTimeout(this.setStateTimeoutId);let t=()=>this.state===b.DISPOSED?y:(this.eventHandler.stateMachine.changeState(e.state),f(void 0));return e.initialDelay===void 0?t():(this.setStateTimeoutId=window.setTimeout(t,e.initialDelay*1e3),f(void 0))}dispose(e){if(this.state===b.DISPOSED)return f(void 0);this.state=b.DISPOSED;let{debug:t}=d();t("[ecas] dispose");try{window.clearTimeout(this.pauseTimeoutId),window.clearTimeout(this.unpauseTimeoutId),window.clearTimeout(this.setStateTimeoutId);for(let n of this.scheduledGameEvents.values()){for(let i of n)window.clearTimeout(i.timeoutId);this.scheduledGameEvents.clear()}for(let n of this.scheduledAudioEvents.values()){for(let i of n)window.clearTimeout(i.timeoutId);this.scheduledGameEvents.clear()}this.shouldMuteOnInvisible=!1,this.soundManager.dispose(),this.audioContext.removeEventListener("statechange",this.onstatechange),this.player.target.removeEventListener("started",this.onsoundstarted),this.player.target.removeEventListener("ended",this.onsoundended),this.player.dispose(),this.audioContext.close().then(()=>{t("[ecas] audio context closed")}).catch(t),this.eventHandler.dispose(),this.busHandler.dispose(),this.visibility.disable();for(let n of this.stages.values())n.dispose();return f(void 0)}catch(n){return I(`[ecas]: error when disposing ecas: ${j(n).message}`)}}resync(e){if(this.state===b.DISPOSED)return y;let{syncerName:t,initialDelay:n=0}=e,i=this.syncers.get(t);if(i===void 0)return I(`[ecas] resync: no syncer found with name ${t}`);let s=this.audioContext.currentTime+n;return i.resync(s),f(void 0)}bufferPlaySync(e){if(this.state===b.DISPOSED)return y;let t=this.player.play(e);return t===0?f(void 0):I(`[ecas] buffer-playback-result: ${Ut(t)}`)}bufferPlayAsync(e){if(this.state===b.DISPOSED)return ir;let t=this.audioContext.currentTime,{maxWaitTime:n=Number.MAX_SAFE_INTEGER,sourceName:i}=e;if(i===void 0)return qe(new Error("[ecas] buffer play async: no source name specified"));let s=()=>{var o;return this.audioContext.currentTime-t<=n?this.bufferPlaySync(e):I(`[ecas] max wait time exceeded when playing ${(o=e.name)!==null&&o!==void 0?o:""}`)};return Ie(this.soundManager.loadSource(i),j).andThen(s)}bufferPlay(e){var t,n,i=K(e,[]);if(this.state===b.DISPOSED)return y;let s=(n=(t=i==null?void 0:i.name)!==null&&t!==void 0?t:i==null?void 0:i.sourceName)!==null&&n!==void 0?n:"",o=Object.assign(Object.assign({name:s},this.buffers.get(s)),i),{sourceName:a}=o;return a===void 0?I("[ecas] buffer play: no source name specified"):o.maxWaitTime===0||this.soundManager.getLoadStateBySource(a)===k.State.LOADED?this.bufferPlaySync(o):this.bufferPlayAsync(o)}bufferStopOldest(e){return this.state===b.DISPOSED?y:(this.player.stopOldest(e),f(void 0))}bufferStopById(e){return this.state===b.DISPOSED?y:(this.player.stopById(e),f(void 0))}bufferStopByName(e){return this.state===b.DISPOSED?y:(this.player.stopByName(e),f(void 0))}bufferStopAll(e){return this.state===b.DISPOSED?y:(this.player.stopAll(e),f(void 0))}bufferApplyEnvelopeByName(e){return this.state===b.DISPOSED?y:(this.player.applyEnvelopeByName(e),f(void 0))}bufferApplyEnvelopeById(e){return this.state===b.DISPOSED?y:(this.player.applyEnvelopeById(e),f(void 0))}bufferApplyEnvelopeToAll(e){return this.state===b.DISPOSED?y:(this.player.applyEnvelopeToAll(e),f(void 0))}containerPlay(e){var{name:t,maxWaitTime:n}=e,i=K(e,["name","maxWaitTime"]);if(this.state===b.DISPOSED)return y;let{debug:s}=d();s("[ecas] containerPlay",t);let o=this.containers.get(t);if(o===void 0)return I(`[ecas] containerPlay: no container found with name ${t}`);let a=o.properties.voices.map(c=>c.sourceName).filter(c=>this.soundManager.getLoadStateBySource(c)!==k.State.LOADED);if(a.length===0||n===0){let c=o.play(i);return c===0?f(void 0):I(`[ecas]: failed to play container ${t}: ${Ut(c)}`)}let l=this.audioContext.currentTime;return Ie(this.soundManager.loadSources(a),j).andThen(()=>{if(this.audioContext.currentTime-l<(n!=null?n:Number.MAX_SAFE_INTEGER)){let m=o.play(i);return m===0?We(void 0):mr(Ut(m))}else return mr(`[ecas] max waitTime exceeded when playing container ${t}`)})}containerStop(e){if(this.state===b.DISPOSED)return y;let t=this.containers.get(e.name);return t===void 0?I(`[ecas] containerStop: no container found with name ${e.name}`):(t.stop(e),f(void 0))}containerReset(e){if(this.state===b.DISPOSED)return y;let t=this.containers.get(e.name);return t===void 0?I(`[ecas] containerReset: no container found with name ${e.name}`):(t.reset(),f(void 0))}loadAllSounds(e={}){if(this.state===b.DISPOSED)return ir;d().debug("[ecas] loadAllSounds");let t=(e==null?void 0:e.onEnded)!==void 0,n=async()=>{let o=this.soundManager.getAllItems();for(;o.length>0;){let a=o.splice(0,Math.min(o.length,32)).filter(u=>u!==void 0);await this.soundManager.loadItems(a)}return null},i=e.throttle==="standard",s=Ie(i?n():this.soundManager.loadEverything(),j);return t?s.andThen(()=>{var o;return this.eventHandler.triggerOnPropertyEventOrAction((o=e.onEnded)!==null&&o!==void 0?o:{}),We(void 0)}):s.map(()=>{})}loadLanguage(e){return Ie(this.soundManager.loadLanguage(e.language,e.packageNames).then(()=>{e.onEnded!==void 0&&this.eventHandler.triggerOnPropertyEventOrAction(e.onEnded)}),j)}loadPackage(e){return Ie(this.soundManager.loadPackageName(e.packageName).then(()=>{e.onEnded!==void 0&&this.eventHandler.triggerOnPropertyEventOrAction(e.onEnded)}),j)}loadTheseSounds(e){if(this.state===b.DISPOSED)return ir;let t=Ye(e),n=t?e:e.ids,i=!t&&e.onEnded!==void 0;d().debug("[ecas] loadTheseSounds",n);let s=Ie(this.soundManager.loadSources(n),j);return i?s.andThen(()=>(this.eventHandler.triggerOnPropertyEventOrAction(e.onEnded),We(void 0))):s.map(()=>{})}loadTheseEvents(e){return this.state===b.DISPOSED?ir:We(void 0)}applyEnvelope({automator:e,paramId:t,curve:n,points:i,delay:s,syncerName:o="default",beatSync:a,beatSyncOffset:u=0}){if(this.state===b.DISPOSED)return y;let l=this.audioContext,c=s!=null?s:0,m=a!==void 0,p=m?this.assetRequester.requestSyncer(o):null;m&&p===null&&d().debug(`[ecas] apply-envelope-error: no beatsyncer for apply envelope to ${t}`);let h=m&&p!==null?p.getSyncTime(a,c,fe(u)):this.audioContext.currentTime;return we({automator:e,context:l,paramId:t,curve:n,points:i,initialDelay:c,when:h})}cancelEnvelope({automator:e,paramId:t,delay:n}){if(this.state===b.DISPOSED)return y;let i=this.audioContext.currentTime+(n!=null?n:0);return e.cancel({paramId:t,when:i}).match(s=>f(void 0),s=>v(s))}busGet({busId:e}){if(this.state===b.DISPOSED)return y;d().debug("[ecas] busGet",e);let t=this.busHandler.get(e);return t===void 0?I(`[ecas] busGet: no bus found with id ${e}`):f(t)}busSetGain({busId:e,gain:t}){var n,i;if(this.state===b.DISPOSED)return y;try{let s=(i=(n=this.busHandler.get(e))===null||n===void 0?void 0:n.automator)===null||i===void 0?void 0:i.get("gain");if(s===void 0)return I(`[ecas] gain param found for bus with id ${e}`);s.value=t}catch(s){return I(`[ecas] no gain param found for bus with id ${e}: ${j(s).message}`)}return f(void 0)}busAddInsert(e){var t,{busId:n,typename:i}=e,s=K(e,["busId","typename"]);if(this.state===b.DISPOSED)return y;let o=(t=s.id)!==null&&t!==void 0?t:"undefined",a=new Error(`[ecas] cannot add ${i} after ecas is initialized. Specify the insert "${o}" directly on the bus(es) "${n.toString()}"`);return d().debug(a.message),v(a)}busAddFilter(e){return this.busAddInsert(Object.assign({typename:J.typename},e))}busAddCompressor(e){return this.busAddInsert(Object.assign({typename:te.typename},e))}busAddAlgorithmicReverb(e){return this.busAddInsert(Object.assign({typename:z.typename},e))}busAddConvolverReverb(e){return this.busAddInsert(Object.assign({typename:Z.typename},e))}busAddDelay(e){return this.busAddInsert(Object.assign({typename:ee.typename},e))}busAddPingPongDelay(e){return this.busAddInsert(Object.assign({typename:re.typename},e))}busApplyEnvelope(e){var t,{busId:n}=e,i=K(e,["busId"]);if(this.state===b.DISPOSED)return y;typeof n=="string"&&(n=[n]);let s=[];for(let o of n){let a=(t=this.busHandler.get(o))===null||t===void 0?void 0:t.automator;if(i.paramId==="pan"&&(a==null?void 0:a.get(i.paramId))===void 0){d().debug(`[ecas] failed to apply envelope to parameter "${i.paramId}". Add "pan" to bus "${o}" to be able to automate pan.`),s.push(o);continue}if(a===void 0){s.push(o);continue}this.applyEnvelope(Object.assign({automator:a},i)).mapErr(u=>{s.push(o)})}return s.length!==0?I(`[ecas]: failed to apply envelope on buses: ${s.join(", ")}`):f(void 0)}busCancelEnvelope(e){var t,{busId:n}=e,i=K(e,["busId"]);if(this.state===b.DISPOSED)return y;typeof n=="string"&&(n=[n]);let s=[];for(let o of n){let a=(t=this.busHandler.get(o))===null||t===void 0?void 0:t.automator;if(a===void 0){s.push(o);continue}this.cancelEnvelope(Object.assign({automator:a},i)).mapErr(u=>{s.push(o)})}return s.length!==0?I(`[ecas]: No bus with id: ${s.join(", ")} found`):f(void 0)}busCancelEnvelopeOnInsert(e){var t,n,{busId:i,insertId:s}=e,o=K(e,["busId","insertId"]);if(this.state===b.DISPOSED)return y;typeof i=="string"&&(i=[i]);let a=[];for(let u of i){let l=(n=(t=this.busHandler.get(u))===null||t===void 0?void 0:t.inserts.get(s))===null||n===void 0?void 0:n.automator;if(l===void 0){a.push(u);continue}this.cancelEnvelope(Object.assign({automator:l},o)).mapErr(c=>a.push(u))}return a.length!==0?I(`[ecas]: failed to cancel envelope on buses ${a.join(", ")}`):f(void 0)}busApplyEnvelopeToCompressor(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:te.typename}))}busApplyEnvelopeToAlgorithmicReverb(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:z.typename}))}busApplyEnvelopeToFilter(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:J.typename}))}busApplyEnvelopeToDelay(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:ee.typename}))}busApplyEnvelopeToPingPongDelay(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:re.typename}))}busApplyEnvelopeToConvolverReverb(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:Z.typename}))}busApplyEnvelopeToGainInsert(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:Oe.typename}))}busApplyEnvelopeToPanInsert(e){return this.busApplyEnvelopeToInsert(Object.assign(Object.assign({},e),{typename:xe.typename}))}busApplyEnvelopeToInsert(e){var t,{busId:n,insertId:i,typename:s}=e,o=K(e,["busId","insertId","typename"]);if(this.state===b.DISPOSED)return y;typeof n=="string"&&(n=[n]);let a=[];for(let u of n){let l=(t=this.busHandler.get(u))===null||t===void 0?void 0:t.inserts.get(i);if(l===void 0){a.push(u);continue}if(kn(l,s)){let c=l.automator;this.applyEnvelope(Object.assign({automator:c},o)).mapErr(m=>a.push(u))}else a.push(u)}return a.length!==0?I(`[ecas]: failed to apply envelope on ${i} buses: ${a.join(", ")}`):f(void 0)}setLanguage(e){return this.state===b.DISPOSED?y:(this.soundManager.setLanguage(e.language),f(void 0))}setMemoryLimit(e){if(this.state===b.DISPOSED)return y;let{megabytes:t,strategy:n}=e;return t!==void 0&&this.soundManager.limiter.setMemoryLimit(t),n!==void 0&&this.soundManager.limiter.setStrategy(n),f(void 0)}stagePlay(e){M`[ecas] stage play ${e.name}`;let t=this.stages.get(e.name);if(t===void 0){let n=`[ecas] unable to find stagebox for ${e.name}`;return d().error(n),v(new Error(n))}return Yi({ecas:this,callback:()=>t.play(e),map:this.scheduledStages,name:e.name,sync:e})}stageCancel(e){M`[ecas] stage cancel ${e.name}`;let t=this.stages.get(e.name);if(t===void 0){let n=`[ecas] unable to find stagebox for ${e.name}`;return d().error(n),v(new Error(n))}return Yi({ecas:this,callback:()=>(ta({map:this.scheduledStages,name:e.name}),t.cancel(e)),map:this.scheduledStages,name:e.name,sync:e})}};function ra(r){var e,t,n;if(r.syncerName===void 0)return;let i=r.assetRequester.requestSyncer(r.syncerName);return i===null?void 0:i.getSyncTime((e=r.beatSync)!==null&&e!==void 0?e:"beat",i.context.currentTime+((t=r.initialDelay)!==null&&t!==void 0?t:0),fe((n=r.beatSyncOffset)!==null&&n!==void 0?n:0))-i.context.currentTime}function Xr(r){var e;if(r.syncerName===void 0)return((e=r.initialDelay)!==null&&e!==void 0?e:0)*1e3;let t=ra(r);return t===void 0?0:Math.floor(Math.max(t*1e3,0))}var Mh=ct.create;var dt=class{constructor(){Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:[]})}add(e,...t){return this.events.push([e,...t]),this}at(e){return e<0?this.events[this.events.length-Math.abs(e)]:this.events[e]}*drain(){let e=this.events.shift();for(;e!==void 0;)yield e,e=this.events.shift()}length(){return this.events.length}};var Yr=class extends Error{constructor(e){super(e),this.name="EcasProviderError"}},na={NOT_READY:new Yr("ecas is not ready")},ft=class{constructor(){Object.defineProperty(this,"ecas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"triggerListeners",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"eventListeners",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"creator",{enumerable:!0,configurable:!0,writable:!0,value:ct.create}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:new dt}),Object.defineProperty(this,"options",{enumerable:!0,configurable:!0,writable:!0,value:{loadrConfig:{queue:!0}}}),Object.defineProperty(this,"onerror",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t,n;(n=(t=d()).onerror)===null||n===void 0||n.call(t,e)}}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:new Promise(e=>{let t=setInterval(()=>{this.ecas!==void 0&&(clearInterval(t),e(this.ecas))},128)})}),Object.defineProperty(this,"disableTriggers",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"context",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maybeQueue",{enumerable:!0,configurable:!0,writable:!0,value:e=>{var t;function n(i,s){return s!==void 0&&(s===!0||s.includes(i))}n(e[0],(t=this.options.loadrConfig)===null||t===void 0?void 0:t.queue)&&this.queue.add(...e)}})}joinSession(e){var t;try{(t=this.socket)===null||t===void 0||t.close();let n=new WebSocket(e);this.socket=n,n.onopen=()=>{n.send(JSON.stringify({type:"ping"}))};let i=(...s)=>{if(n.readyState===WebSocket.OPEN){let o=JSON.stringify({type:"trigger",data:s,timestamp:performance.now()});n.send(o)}};n.onopen=()=>{this.addTriggerListener("any",i)},n.onclose=()=>{this.removeTriggerListener("name",i)}}catch(n){}return this}addTriggerListener(e,t){let n=this.triggerListeners.get(e);return n===void 0?this.triggerListeners.set(e,[t]):n.push(t),this}removeTriggerListener(e,t){var n;let i=(n=this.triggerListeners.get(e))!==null&&n!==void 0?n:[],s=i.indexOf(t);return s>-1&&i.splice(s,1),this.triggerListeners.set(e,i),this}emitTrigger(e){var t;let n=(t=this.triggerListeners.get(e[0]))!==null&&t!==void 0?t:this.triggerListeners.get("any");return n!==void 0&&n.forEach(i=>i.apply(i,e)),this}addEventListener(e,t){let n=this.eventListeners.get(e);return n===void 0?this.eventListeners.set(e,[t]):n.push(t),this.ecas!==void 0&&this.ecas.eventHandler.on(e,t),this}removeEventListener(e,t){var n;let i=(n=this.eventListeners.get(e))!==null&&n!==void 0?n:[],s=i.indexOf(t);return s>-1&&i.splice(s,1),this.eventListeners.set(e,i),this.ready.then(o=>{o.eventHandler.off(e,t)}).catch(this.onerror.bind(this)),this}emitEvent(...e){return this.ready.then(t=>{t.eventHandler.emit(...e)}).catch(this.onerror.bind(this)),this}withOptions(e){return this.options=e,this}requeue(){return[...this.queue.drain()].forEach(this.maybeQueue.bind(this)),this}load(){this.dispose(),this.requeue();let e=pt(),t=bt(e);t!=="none"&&this.joinSession(t);let n=e.get("ecas-disable-triggers").unwrapOr("false");return this.disableTriggers=n==="true",this.creator(this.options,this.context,this.socket).then(i=>{this.ecas=i;for(let[s,o]of this.eventListeners.entries())o.forEach(a=>{i.eventHandler.on(s,a)});for(let s of this.queue.drain())this.fire(...s)}).catch(this.onerror.bind(this)),this}trigger(...e){return this.ecas===void 0?this.maybeQueue(e):this.fire(...e),this.emitTrigger(e)}fire(...e){if(this.disableTriggers)return this;try{let t=this.ecas.eventHandler;t.triggerGameEvent.apply(t,e).map(n=>n.mapErr(this.onerror.bind(this)))}catch(t){this.onerror(j(t))}return this}get requiredEcas(){if(this.ecas===void 0)throw na.NOT_READY;return this.ecas}dispose(){var e,t,n;(e=this.socket)===null||e===void 0||e.close(0,"done");try{(t=this.ecas)===null||t===void 0||t.bufferStopAll({}),(n=this.ecas)===null||n===void 0||n.dispose()}catch(i){this.onerror(new Error(`[ecas] dispose: call to bufferStopAll failed: ${j(i).message}`))}return this.ecas=void 0,this}delete(){this.dispose(),window.ecas!==void 0&&delete window.ecas}reset(){return this.dispose(),this.queue=new dt,this.options={loadrConfig:{queue:!0}},this}withOnerror(e){return this.onerror=e,this}withCreator(e){return this.creator=e,this}withLoadrConfig(e){return this.options=Ct(this.options,e),this}withPrependLoadPath(e){return this.options=Ar(this.options,e),this}withQueue(e){return this.options=Or(this.options,e),this}withLogger(e){return this.options=wr(this.options,e),this}withLoadPath(e){return this.options=Nt(this.options,e),this}withPauseOnInvisible(e){return this.options=Object.assign(Object.assign({},this.options),{loadrConfig:Object.assign(Object.assign({},this.options.loadrConfig),{pauseOnInvisible:e,resumeOnVisible:e})}),this}withMuteOnInvisible(e){return this.options=Object.assign(Object.assign({},this.options),{loadrConfig:Object.assign(Object.assign({},this.options.loadrConfig),{muteOnInvisible:e,unmuteOnVisible:e})}),this}withPause(e){return this.options=xr(this.options,e),this}withPreload(e){return this.options=Object.assign(Object.assign({},this.options),{loadrConfig:Object.assign(Object.assign({},this.options.loadrConfig),{preload:e})}),this}async fetchConfig(e){try{return await window.fetch(e).then(async t=>await t.json()).then(t=>typeof t=="object"&&t!==null&&(t.soundConfig!==void 0||t.eventConfig!==void 0||t.stateConfig!==void 0||t.loadrConfig!==void 0)?t:void 0)}catch(t){this.onerror(new Error(`[ecas] failed to fetch config from ${e} due to error: ${j(t).message}`));return}}withFetchConfigAndLoad(e){return this.fetchConfig(e).then(t=>{var n,i,s,o;if(t===void 0){this.onerror(new Error(`[ecas] failed to fetch config from ${e}`));return}this.options=Object.assign(Object.assign({},this.options),{loadrConfig:Object.assign(Object.assign({},this.options.loadrConfig),{queue:(o=(i=(n=t.loadrConfig)===null||n===void 0?void 0:n.queue)!==null&&i!==void 0?i:(s=this.options.loadrConfig)===null||s===void 0?void 0:s.queue)!==null&&o!==void 0?o:!0})}),this.withOptions(Rt(t,this.options)).load()}).catch(this.onerror.bind(this)),this}withStateConfig(e){return this.options=Pr(this.options,e),this}withSoundConfig(e){return this.options=Re(this.options,e),this}withEventConfig(e){return this.options=Er(this.options,e),this}withExtendOptions(e){return this.options=Rt(this.options,e),this}};var sr;typeof window=="undefined"?sr=new ft:window.ecas!==void 0?sr=window.ecas:sr=window.ecas=new ft;var gp=sr;export{gp as default};
